{"hash":"e0fe8f3c0e0a06b4331f8235dffa4da8e41892ab","data":{"tag":{"id":"Express.js","title":"Express.js","path":"/tag/Express.js/","belongsTo":{"totalCount":1,"pageInfo":{"totalPages":1,"currentPage":1},"edges":[{"node":{"id":"b86316117b02f0df7b890fc2071827cc","title":"Membuat API Rate Limiting menggunakan Redis pada Express.js","datetime":"2019-12-01 11:00:00","path":"/artikel/membuat-api-rate-limiting-redis-express/","icon":"/images/icons/redis.png","content":"<p>Beberapa waktu yang lalu, saya sempat menuliskan catatan kursus Redis saya di <a href=\"university.redislabs.com/\">Redis University</a>. Tapi catatannya tidak saya lanjutkan karena <del>materi yang dibahas antar kelas yang satu dengan kelas yang lainnya banyak yang mirip-mirip</del> saya malas. Sebagai gantinya, saya akan menuliskan beberapa artikel Redis yang sekiranya banyak dibutuhkan oleh industri. Salah satunya adalah Rate Limiting ini.</p>\n<p>Rate Limiting adalah proses membatasi jumlah request user/client pada resource tertentu.\nSebagai contoh disini kita akan coba membatasi akses user terhadap API yang dibuat menggunakan Express.js pada setiap menitnya.</p>\n<p>Sebelum mencoba ini, pastikan kamu sudah menginstall <strong><a href=\"https://redis.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redis</a></strong> dan <strong><a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node.js</a></strong>. Pada tutorial ini saya menggunakan Node.js versi 10.15.3 dan Redis versi 5.0.5.\nBuat kamu yang pakai Windows seperti saya, kamu dapat menjalankan Redis menggunakan Docker seperti yang saya lakukan saat membuat artikel ini.</p>\n<p>Kalau Redis dan Node.js-nya sudah siap, sebelum masuk ke tahap coding, silahkan jalankan terlebih dahulu redis-server kamu.</p>\n<h2 id=\"persiapan\"><a href=\"#persiapan\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Persiapan</h2>\n<p>Saya akan <em>to-the-point</em> aja disini, kalau bingung silahkan tanya saya via <a href=\"https://www.facebook.com/em.sifa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">facebook</a>.</p>\n<ul>\n<li>Buka terminal atau cmd (selanjutnya saya akan sebut terminal aja).</li>\n<li>Buat direktori baru: <code>mkdir express-rate-limiting</code></li>\n<li>Masuk ke direktori tersebut: <code>cd express-rate-limiting</code></li>\n<li>Inisiasi file package.json: <code>npm init -y</code></li>\n<li>Install package yang dibutuhkan: <code>npm i -S express redis bluebird date-fns</code></li>\n</ul>\n<p>Berikut sedikit penjelasan tentang package yang kita install diatas:</p>\n<ul>\n<li><code>express</code>: untuk membuat Web API.</li>\n<li><code>redis</code>: untuk koneksi dan mengirim perintah ke redis server.</li>\n<li><code>bluebird</code>: untuk membuat versi Promise pada setiap API/function di package redis.</li>\n<li><code>date-fns</code>: untuk format tanggal.</li>\n</ul>\n<h2 id=\"konsep\"><a href=\"#konsep\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Konsep</h2>\n<p>Goal pada aplikasi yang akan kita buat disini adalah untuk\nmembatasi akses ke endpoint <code>GET /hello</code> supaya setiap IP\nhanya dapat mengakses sebanyak 10 kali saja setiap menitnya.</p>\n<p>Untuk mencapai goal tersebut, kita akan memanfaatkan 3 perintah redis, yaitu:</p>\n<ul>\n<li><code>GET</code>: untuk mengambil nilai dari key.</li>\n<li><code>INCR</code>: untuk increment nilai numerik dari key.</li>\n<li><code>EXPIRE</code>: untuk set expiration key supaya nilai dari keynya otomatis hilang dalam kurun waktu tertentu, sehingga tidak membebani memori berkepanjangan. Istilah kerennya <em>time-based retention</em>.</li>\n</ul>\n<p>Pemanfaatannya adalah sebagai berikut:</p>\n<ul>\n<li>Ambil jumlah akses (nilai numerik) dari key menggunakan <code>GET</code>.</li>\n<li>\n<p>Jika jumlah akses melebihi batas (10):</p>\n<ul>\n<li>Kirim response error 429 (Too Many Requests).</li>\n</ul>\n</li>\n<li>\n<p>Jika jumlah akses dibawah atau sama dengan batas (10):</p>\n<ul>\n<li>Increment nilai dari key menggunakan <code>INCR</code>.</li>\n<li>Set expire dari key menggunakan <code>EXPIRE</code>.</li>\n<li>Kirim response sukses.</li>\n</ul>\n</li>\n</ul>\n<p>Supaya <u>setiap IP</u> hanya boleh mengakses <u>path tertentu</u> pada <u>setiap menitnya</u>.\nKita akan membuat keynya dengan format seperti ini:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">{IP}:{PATH}:{TAHUN}{BULAN}{TANGGAL}:{JAM}{MENIT}</code>\n<p>Contoh jika IP <code>1.2.3.4</code> mengakses <code>\"/hello\"</code> pada <code>2019-12-01 10:15:25</code>. Keynya akan seperti ini:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">1.2.3.4:/hello:20191201:1015</code>\n<p>Sebagai gambaran, berikut adalah table skenario request yang dijalankan oleh <code>1.2.3.4</code> ke path <code>/hello</code> pada waktu tertentu:</p>\n<div class=\"table-responsive\">\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>No.</strong></th>\n<th align=\"center\"><strong>Waktu</strong></th>\n<th align=\"center\"><strong>Key</strong></th>\n<th align=\"center\"><strong>Value</strong></th>\n<th align=\"center\"><strong>Hasil</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">1</td>\n<td align=\"center\">2019-12-01 10:01:00</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">1</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">2</td>\n<td align=\"center\">2019-12-01 10:01:01</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">2</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">3</td>\n<td align=\"center\">2019-12-01 10:01:05</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">3</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\">2019-12-01 10:01:12</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">4</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">5</td>\n<td align=\"center\">2019-12-01 10:01:16</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">5</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\">2019-12-01 10:01:18</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">6</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">7</td>\n<td align=\"center\">2019-12-01 10:01:19</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">7</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">8</td>\n<td align=\"center\">2019-12-01 10:01:21</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">8</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">9</td>\n<td align=\"center\">2019-12-01 10:01:25</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">9</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">10</td>\n<td align=\"center\">2019-12-01 10:01:30</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">10</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">11</td>\n<td align=\"center\">2019-12-01 10:01:36</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">11</td>\n<td align=\"center\"><strong class=\"text-red-500\">error</strong></td>\n</tr>\n<tr>\n<td align=\"center\">12</td>\n<td align=\"center\">2019-12-01 10:01:40</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">11</td>\n<td align=\"center\"><strong class=\"text-red-500\">error</strong></td>\n</tr>\n<tr>\n<td align=\"center\">13</td>\n<td align=\"center\">2019-12-01 10:<strong class=\"bg-gray-200 text-gray-800\">02</strong>:05</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:10<strong class=\"bg-gray-200 text-gray-800\">02</strong></td>\n<td align=\"center\"><strong class=\"bg-gray-200 text-gray-800\">1</strong></td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"implementasi\"><a href=\"#implementasi\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Implementasi</h2>\n<p>Sekarang saatnya masuk ke <em>text editor</em> atau <em>IDE</em> favorit kamu.\nPertama-tama silahkan buat file <code>app.js</code> pada direktori yang sama dengan file <code>package.json</code>.\nLalu kita akan masuk ke tahap berikutnya.</p>\n<h4 id=\"1-import-package\"><a href=\"#1-import-package\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>1. Import Package</h4>\n<p>Sebelum menuliskan <em>app logic</em>-nya, mari kita import dulu <em>package</em> yang sudah kita install sebelumnya.</p>\n<p>Isikan kode seperti dibawah ini pada file <code>app.js</code> kamu:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<h4 id=\"2-promisify\"><a href=\"#2-promisify\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>2. Promisify</h4>\n<p>Pada tahap ini kita akan menggunakan bluebird untuk menambahkan <em>Promise-based</em> function pada setiap API/function yang tersedia pada <em>package</em> redis.</p>\n<p>Silahkan tambahkan baris berikut setelah <em>require-require</em> sebelumnya.</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span></code></pre>\n<blockquote>\n<p>Promise-based function berfungsi untuk menghindari <a href=\"http://callbackhell.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">callback-hell</a></p>\n</blockquote>\n<h4 id=\"3-membuat-dan-menghubungkan-redis-client\"><a href=\"#3-membuat-dan-menghubungkan-redis-client\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>3. Membuat dan Menghubungkan Redis Client</h4>\n<p>Selanjutnya, untuk dapat mengirimkan perintah ke redis-server, kita perlu membuat dan menghubungkan redis client terlebih dahulu.</p>\n<p>Tambahkan baris berikut dibawah tahap sebelumnya:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<p>Kalau sudah, kamu dapat test koneksi menggunakan terminal dengan perintah:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">node app</span></code></pre>\n<p>Tunggu sebentar, kalau muncul error <code>ECONNREFUSED</code>, kemungkinannya:</p>\n<ul>\n<li>Redis server belum running</li>\n<li>Hostnya salah</li>\n<li>Portnya salah</li>\n</ul>\n<p>Silahkan cek dan sesuaikan lagi.</p>\n<h4 id=\"4-inisiasi-express-app\"><a href=\"#4-inisiasi-express-app\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>4. Inisiasi Express App</h4>\n<p>Setelah koneksi redis client berhasil, saatnya kita membuat aplikasi webnya.</p>\n<p>Lanjut dibawah kode sebelumnya. Ketikkan kode berikut:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<hr>\n<details><summary>Kode keseluruhan pada tahap ini:</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<h4 id=\"5-menerapkan-rate-limiting-pada-endpoint-get-hello\"><a href=\"#5-menerapkan-rate-limiting-pada-endpoint-get-hello\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>5. Menerapkan Rate Limiting pada Endpoint \"GET /hello\"</h4>\n<p>Pada tahap ini kita akan memanfaatkan redis client untuk membatasi akses ke endpoint <code>GET /hello</code>\nsupaya setiap IP hanya dapat mengakses sebanyak 10 kali saja pada setiap menitnya.</p>\n<p>Silahkan ubah <code>app.get('/hello', ...)</code> pada tahap sebelumnya menjadi seperti ini (pahami penjelasan baris-per-baris):</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> limit </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">      </span><span style=\"color: #888\">// limit akses setiap menitnya</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> path </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #888\">// path dari API</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">) </span><span style=\"color: #888\">// waktu untuk dijadikan key  </span>\n<span style=\"color: #FFFFFF\">  </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Set redis key yang digunakan untuk menyimpan </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// jumlah akses oleh IP: req.ip, untuk path: path, pada menit: time</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span><span style=\"color: #FFFFFF\"> </span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Ambil jumlah akses saat ini</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kalau jumlah akses melebihi limit ...</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">      </span><span style=\"color: #888\">// ... kirim response error 429</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Jalankan transaction untuk:</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> trx </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)         </span><span style=\"color: #888\">// 1. increment key</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)   </span><span style=\"color: #888\">// 2. set expire key 60 detik</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kirim response yang seharusnya</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<p>Hmm, panjang juga ya. Kalau belum paham, baca ulang lagi aja sampai paham.</p>\n<p>Pada saat mengeset variable <code>key</code>, kamu dapat sesuaikan sesuai kebutuhan kamu.\nMisal untuk IP diatas dapat kamu ganti dengan token.\nAtau misal kamu mau batasinya per jam, kamu dapat ubah format<code>time</code>-nya menjadi <code>yyyyMMdd:HH</code> aja.\nAtau misalkan lagi kamu mau batasi secara global, bukan hanya pada path <code>/hello</code> aja,\nkamu dapat hilangkan informasi <code>path</code> pada <code>key</code>-nya.</p>\n<hr>\n<details><summary>Kode keseluruhan pada tahap ini:</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> limit </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">      </span><span style=\"color: #888\">// limit akses setiap menitnya</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> path </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #888\">// path dari API</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">) </span><span style=\"color: #888\">// waktu untuk dijadikan key  </span>\n<span style=\"color: #FFFFFF\">  </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Set redis key yang digunakan untuk menyimpan </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// jumlah akses oleh IP: req.ip, untuk path: path, pada menit: time</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span><span style=\"color: #FFFFFF\"> </span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Ambil jumlah akses saat ini</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kalau jumlah akses melebihi limit ...</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">    </span><span style=\"color: #888\">// ... kirim response error 429</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Jalankan transaction untuk:</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> trx </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)         </span><span style=\"color: #888\">// 1. increment key</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)   </span><span style=\"color: #888\">// 2. set expire key 60 detik</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kirim response yang seharusnya</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<h4 id=\"6-cobain\"><a href=\"#6-cobain\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>6. Cobain</h4>\n<p>Sampai sini, rate limiting kita sudah jadi.\nSilahkan jalankan kembali perintah <code>node app</code> pada terminal.\nKemudian buka web browser, bukalah URL <code>http://localhost:3000/hello</code>.</p>\n<p>Seharusnya, pada 10 request pertama kamu akan mendapatkan response seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"Hello World\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Sedangkan pada request selanjutnya, kamu akan mendapatkan response seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"error\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"API rate limit exceeded\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Lalu coba tunggu 1 menit, kemudian akses <code>/hello</code> lagi. Responsenya akan kembali seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"Hello World\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Artinya rate-limiting kita sudah berhasil membatasi 10 kali akses pada setiap menitnya.</p>\n<h2 id=\"penutup\"><a href=\"#penutup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Penutup</h2>\n<p>Sampai sini saya harap kamu sudah paham tentang Rate Limiting, serta penerapan Rate Limiting menggunakan Redis (khususnya) pada Express.js. Untuk bahasa dan framework lain, tahapannya kurang/lebih sama.\nYaitu kamu cukup memanfaatkan perintah <code>get</code>, <code>incr</code> dan <code>expire</code> pada Redis client di bahasa/framework itu.</p>\n<p>Sebagai bonus, dibawah ini saya lampirkan kode middleware dari penerapan Rate Limiting kita diatas.\nDengan middleware ini, kamu dapat menerapkan rate-limiting ke berbagai endpoint cukup dengan 1 baris pemanggilan fungsi middleware ini.</p>\n<hr>\n<details><summary>BONUS</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Middleware rate limit per menit</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">rateLimitPerMinute</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">limit</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> path</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> next</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path </span><span style=\"color: #EFEFEF\">||</span><span style=\"color: #FFFFFF\"> req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span>\n<span style=\"color: #FFFFFF\">    </span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">        message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">      </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">    </span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> mul </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">    mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)</span>\n<span style=\"color: #FFFFFF\">    mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">next</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">rateLimitPerMinute</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<p>Yaudah sekian dulu artikel kali ini. Semoga bermanfaat. Dadah ~</p>\n","excerpt":"","description":"Membatasi jumlah akses API setiap menitnya menggunakan Redis pada Express.js.","author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}}]}}},"context":{}}