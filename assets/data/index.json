{"hash":"5d4d564b1c56245156a11069ec5b7b95bce96930","data":{"articles":{"count":12,"edges":[{"node":{"id":"116ffefcd4827a27cdb836df5a968e9d","title":"Cegah XSS dengan Content-Security-Policy","datetime":"2020-01-24 11:00:00","content":"<p>Kemarin lusa (1/22), saya menerima laporan dari admin website kementerian yang saya buat kalau\nwebnya mengalami kendala hanya menampilkan <em>preloader</em> saja. Setelah saya cek melalui <em>devtools browser</em>,\npada bagian console, saya mendapati kalau <em>browser</em> tidak diizinkan untuk me-<em>load</em> <em>javascript</em>, <em>css</em>, maupun <em>font</em> yang berasal\ndari <a href=\"https://cdnjs.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cdnjs</a> dan <a href=\"https://unpkg.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">unpkg</a>. Alhasil sebagian script yang dibutuhkan\ntidak di-<em>load</em>, yaudah, rusak deh. Kurang lebih penampakan errornya (di Firefox) kayak gini:</p>\n<p><img src=\"/images/posts/ss-csp-error.png\" alt=\"CSP Error\"></p>\n<p>Ternyata sebelumnya dari pihak IT pusat sana, web servernya baru disetting untuk mengirimkan <em>header</em> <code>Content-Security-Policy</code> yang berisikan <em>whitelist</em> <em>host</em> mana saja yang diperbolehkan untuk di-<em>load</em> oleh website-website yang berada pada server naungan mereka, dan <em>cdnjs.cloudflare.com</em> serta <em>unpkg.com</em> tidak terdaftar dalam <em>whitelist</em> tersebut. Karena saya cuma dikasih akses ke sebagian fitur <em>cpanel</em>-nya aja, alhasil yang saya lakukan adalah mengunduh semua <em>resource</em> pada <em>CDN</em>, dan mengunggahnya ke server mereka, lalu mengubah kode <em>HTML</em> dari yang tadinya load ke <em>URL</em> <em>CDN</em> menjadi load ke <em>URL</em> website itu sendiri.</p>\n<p>Apa yang dilakukan IT pihak pusat memang sudah benar, yaitu mencegah potensi <em>XSS</em> dari berbagai website yang dikembangkan berbagai developer (dan vendor) yang hosting websitenya ke server mereka, dimana jika ada salah satu website saja <em>vuln</em>, maka website lain bisa terpengaruh karenanya.</p>\n<p>Setelah kejadian ini saya baca-baca lagi tentang <strong><em>Content-Security-Policy (CSP)</em></strong>, dan <del>supaya menjadi manfaat</del> karena blog saya udah lama ga update, saya tulis sekalian disini.</p>\n<blockquote>\n<p>Setelah ini saya akan singkat <strong><em>Content-Security-Policy</em></strong> menjadi <strong><em>CSP</em></strong> saja.</p>\n</blockquote>\n<h2 id=\"apa-itu-csp\"><a href=\"#apa-itu-csp\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Apa itu <em>CSP</em>?</h2>\n<p><em>CSP</em> adalah <em>HTTP Response Header</em> atau <em>Meta Tag</em> untuk mengatur <strong>resource dari sumber mana saja</strong>\nyang diperbolehkan untuk dieksekusi oleh <em>web browser</em> (yang <a href=\"https://caniuse.com/#search=CSP\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mendukung <em>CSP</em></a> tentunya).</p>\n<p>Yang dimaksud <em>resource</em> disini itu ya <a href=\"https://en.wikipedia.org/wiki/Web_resource\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>web resource</em></a>, seperti <em>javascript</em>, <em>css</em>, <em>font</em>, <em>image</em>, <em>video</em>, <em>audio</em>, dsb.</p>\n<p>Dengan <em>CSP</em> kita dapat meminimalisir potensi-potensi serangan XSS pada website kita dengan memerintahkan <em>browser</em> untuk jangan me-<em>load</em> dan mengeksekusi <em>resource</em> dari sumber yang tidak kita inginkan.</p>\n<h2 id=\"apa-yang-bisa-kita-lakukan-dengan-csp\"><a href=\"#apa-yang-bisa-kita-lakukan-dengan-csp\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Apa yang bisa kita lakukan dengan <em>CSP</em>?</h2>\n<p>Dengan memberikan <em>CSP</em> ke halaman web kamu, kamu dapat:</p>\n<ul>\n<li>Mencegah <em>browser</em> untuk mengeksekusi <em>inline script</em> (<em>javascript</em> di <em>HTML</em>).</li>\n<li>Mencegah <em>browser</em> untuk mengeksekusi <code>eval</code>.</li>\n<li>Mencegah <em>browser</em> untuk mengeksekusi <em>inline style</em>.</li>\n<li>Mencegah <em>browser</em> untuk mengeksekusi <em>script</em>, <em>css</em>, <em>font</em>, gambar, video, suara, dsb diluar host yang kita tentukan.</li>\n<li>Mencegah <em>browser</em> untuk submisi form yang <code>action</code>-nya menuju ke host yang tidak kita daftarkan.</li>\n<li>Mencegah <em>browser</em> untuk menjalankan <em>Ajax</em>, maupun <em>WebSocket</em> diluar host yang kita tentukan.</li>\n<li>dll.</li>\n</ul>\n<h2 id=\"bagaimana-csp-dapat-mencegah-xss\"><a href=\"#bagaimana-csp-dapat-mencegah-xss\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Bagaimana <em>CSP</em> dapat Mencegah <em>XSS</em>?</h2>\n<p>Serangan <em>XSS</em> umumnya berasal dari form yang disubmit oleh user, yang kemudian isian dari form tersebut di-<em>render</em> ke user lain sebagai kode <em>HTML</em> (tidak di-<em>escaping</em>).</p>\n<p>Contoh sederhananya adalah form komentar. Misalkan ada user memasukkan kode <code>&#x3C;script>alert('oi')&#x3C;/script></code> pada kolom komentar,  dan <em>server-side</em> tidak melakukan <em>escaping</em> terhadap komentar tersebut, yang terjadi saat komentar tersebut di-<em>render</em> ke user lain adalah <em>browser</em> akan mengeksekusi <em>inline script</em> tersebut untuk menampilkan <em>alert</em> ke user tersebut.</p>\n<p>Dengan <em>CSP</em>, kita dapat menghindari hal ini dengan cara memerintahkan browser untuk jangan eksekusi <em>inline script</em> melalui <em>response header</em> ataupun <em>meta tag</em>. Jadi sekalipun developer khilaf tidak melakukan <em>escaping</em>, serangan <em>XSS</em> dapat dihindari.</p>\n<h2 id=\"penulisan-csp\"><a href=\"#penulisan-csp\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Penulisan <em>CSP</em></h2>\n<p>Seperti yang sudah saya bilang sebelumnya, <em>CSP</em> dapat kita tuliskan pada <em>response header</em>, ataupun <em>meta tag</em>.\nHanya saja, artikel yang saya baca di halaman <a href=\"https://developers.google.com/web/fundamentals/security/csp#the_meta_tag\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Developers</a> lebih menyarankan menggunakan <em>response header</em>. Jadi disini saya akan mencontohkan menggunakan <em>response header</em> saja.</p>\n<p>Untuk penulisan <em>header CSP</em>, formatnya adalah sebagai berikut:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">Content-Security-Policy: &lt;policy-directive-1&gt;; &lt;policy-directive-2&gt;; &lt;policy-directive-n&gt;</code>\n<p>Sedangkan untuk penulisan <code>&#x3C;policy-directive></code> formatnya adalah seperti ini:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">&lt;directive-a&gt; &lt;source-1&gt; &lt;source-2&gt; &lt;source-n&gt;</code>\n<p>Sebagai contoh, jika kita hanya memperbolehkan <em>load</em> <em>script</em> dan <em>css</em> dari <code>web-a.com</code> dan <code>web-b.com</code>,\nkita dapat menuliskan <em>CSP</em> seperti ini:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">Content-Security-Policy: script-src https://web-a.com https://web-b.com; style-src https://web-a.com https://web-b.com</code>\n<p>Pada contoh diatas kita menggunakan <em>directive</em> <code>script-src</code> dan <code>style-src</code>.\nDibawah ini adalah daftar beberapa <em>directive</em> yang dapat kamu gunakan:</p>\n<ul>\n<li><code>connect-src</code>: membatasi akses ajax (<em>XMLHttpRequest</em>), <em>WebSocket</em>, dan <em>EventSource</em>.</li>\n<li><code>font-src</code>: membatasi akses font.</li>\n<li><code>img-src</code>: membatasi akses image.</li>\n<li><code>script-src</code>: membatasi akses script.</li>\n<li><code>style-src</code>: membatasi akses style (css).</li>\n<li><code>media-src</code>: membatasi akses video dan audio.</li>\n<li><code>worker-src</code>: membatasi akses service worker.</li>\n<li><code>child-src</code>: membatasi akses iframe dan worker.</li>\n<li><code>form-action</code>: membatasi <code>action</code> dari form.</li>\n<li><code>default-src</code>: kalau kamu malas jabarkan satu-persatu, kamu bisa gunakan ini untuk membatasi semua hal diatas.</li>\n</ul>\n<p>Daftar diatas bisa saja bertambah atau berubah suatu saat, untuk itu, selebihnya bisa kamu pelajari sendiri pada artikel <a href=\"https://developers.google.com/web/fundamentals/security/csp#policy_applies_to_a_wide_variety_of_resources\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>CSP</em> di Google Developers</a> atau panduan <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy#Directives\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>CSP</em> di MDN</a>.</p>\n<p>Selanjutnya, selain mendaftarkan <em>host</em> apa saja yang diperbolehkan, <em>CSP</em> juga memiliki beberapa keyword yang dapat kamu gunakan sebagai <code>&#x3C;source></code> seperti dibawah ini:</p>\n<ul>\n<li><code>'self'</code>: untuk memperbolehkan <em>browser</em> load resource dari domain yang sama dengan website di-<em>load</em>.</li>\n<li><code>'unsafe-inline'</code>: untuk memperbolehkan <em>browser</em> mengeksekusi <em>inline script</em> ataupun <em>inline style</em>.</li>\n<li><code>'unsafe-eval'</code>: untuk memperbolehkan <em>browser</em> mengeksekusi fungsi javascript <code>eval</code>.</li>\n<li><code>'none'</code>: jika kamu tidak memperbolehkan <em>browser</em> load resource dari sumber manapun.</li>\n</ul>\n<blockquote>\n<p>Keyword diatas harus kamu tulis dengan menyertakan tanda petik tunggal.</p>\n</blockquote>\n<h2 id=\"contoh-penerapan-csp\"><a href=\"#contoh-penerapan-csp\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Contoh Penerapan <em>CSP</em></h2>\n<p>Pada bagian ini saya menuliskan contoh-contoh <em>CSP</em> umum yang mungkin banyak orang butuhkan.\nDisini dimisalkan saya <em>host</em> halaman-halaman contoh ini pada <code>https://www.emsifa.com</code>.</p>\n<blockquote>\n<p>Disini saya akan menggunakan PHP supaya lebih ringkas aja.</p>\n</blockquote>\n<h4 id=\"1-memperbolehkan-semua-jenis-resource-dari-domain-yang-sama\"><a href=\"#1-memperbolehkan-semua-jenis-resource-dari-domain-yang-sama\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>1. Memperbolehkan Semua Jenis Resource dari Domain yang Sama</h4>\n<p>Dari kebutuhan diatas, kita dapat terjemahkan menjadi:</p>\n<ul>\n<li>Semua Jenis Resource: <code>default-src</code></li>\n<li>Dari Domain yang Sama: <code>'self'</code></li>\n</ul>\n<p>Jadi penerapan <em>CSP</em>-nya adalah sebagai berikut:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FAC863\">header</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Content-Security-Policy: default-src 'self'\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">?&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;html&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;body&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.emsifa.com/js/app.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://cdnjs.cloudflare.com/jquery/jquery.min.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script&gt;alert</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'hello'</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #2BA8FF\">&lt;/script&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/body&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/html&gt;</span></code></pre>\n<p>Pada contoh diatas, script <code>app.js</code> akan di-<em>load</em> dan dieksekusi oleh browser, sedangkan script jQuery tidak akan dieksekusi karena berada pada host <code>cdnjs.cloudflare.com</code>, dan script <code>alert('hello')</code> dibawahnya juga tidak akan dieksekusi karena kita tidak mendaftarkan <code>'unsafe-inline'</code> pada header CSP.</p>\n<h4 id=\"2-memperbolehkan-semua-jenis-resource-dari-sumber-yang-sama-dan-cdnjs\"><a href=\"#2-memperbolehkan-semua-jenis-resource-dari-sumber-yang-sama-dan-cdnjs\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>2. Memperbolehkan Semua Jenis Resource dari Sumber yang Sama dan CDN.js</h4>\n<p>Dari kebutuhan diatas, kalau kita terjemahkan kedalam CSP, menjadi:</p>\n<ul>\n<li>Semua Jenis Resource: <code>default-src</code></li>\n<li>Sumber yang sama dan CDN.js: <code>'self' https://cdnjs.cloudflare.com</code></li>\n</ul>\n<p>Kalau kita terapkan ke <em>CSP</em> akan menjadi:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FAC863\">header</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Content-Security-Policy: default-src 'self' https://cdnjs.cloudflare.com\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">?&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;html&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;body&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.emsifa.com/js/app.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://cdnjs.cloudflare.com/jquery/jquery.min.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script&gt;alert</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'hello'</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #2BA8FF\">&lt;/script&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/body&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/html&gt;</span></code></pre>\n<p>Pada contoh diatas, <code>app.js</code> dan jQuery akan di-<em>load</em> oleh <em>browser</em>, sedangkan script <code>alert('hello')</code> tetap diblokir oleh <em>browser</em>.</p>\n<h4 id=\"3-hanya-memperbolehkan-script-css-dan-image-dari-hosting-sendiri-tidak-memperbolehkan-video-dan-audio-apapun-tapi-memperbolehkan-embed-video-youtube\"><a href=\"#3-hanya-memperbolehkan-script-css-dan-image-dari-hosting-sendiri-tidak-memperbolehkan-video-dan-audio-apapun-tapi-memperbolehkan-embed-video-youtube\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>3. Hanya Memperbolehkan <em>Script</em>, <em>CSS</em>, dan <em>Image</em> dari <em>Hosting</em> Sendiri, tidak Memperbolehkan Video dan Audio Apapun, tapi memperbolehkan Embed Video Youtube</h4>\n<p>Oke, kita coba terjemahkan dulu kebutuhan diatas:</p>\n<ul>\n<li>Hanya Memperbolehkan Script CSS dan Image dari Hosting sendiri: artinya kita memerlukan 3 buah directive yaitu <code>script-src</code>, <code>style-src</code>, dan <code>img-src</code> yang memperbolehkan <code>'self'</code>.</li>\n<li>Tidak memperbolehkan Video dan Audio Apapun: artinya kita perlu menuliskan directive <code>media-src</code> menjadi <code>'none'</code>.</li>\n<li>Tapi memperbolehkan Embed Video Youtube: artinya kita perlu menuliskan directive <code>child-src</code> ke <code>https://youtube.com</code>.</li>\n</ul>\n<p>Kalau kita terapkan ke header <em>CSP</em> menjadi seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FAC863\">header</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Content-Security-Policy: script-src 'self'; style-src 'self'; img-src: 'self'; media-src 'none'; child-src https://youtube.com\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">?&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;html&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;head&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;link</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">rel</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"stylesheet\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">href</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.emsifa.com/css/style.css\"</span><span style=\"color: #2BA8FF\">/&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;link</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">rel</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"stylesheet\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">href</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://cdnjs.cloudflare.com/bootstrap/css/bootstrap.min.css\"</span><span style=\"color: #2BA8FF\">/&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;style&gt;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">img</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">width</span><span style=\"color: #FFFFFF\">:</span><span style=\"color: #9FBDE0\"> </span><span style=\"color: #2BA8FF\">100</span><span style=\"color: #FF0078\">px</span><span style=\"color: #EFEFEF\">;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;/style&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/head&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;body&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;img</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.emsifa.com/img/logo.png\"</span><span style=\"color: #2BA8FF\">/&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;img</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.w3schools.com/img/logo.png\"</span><span style=\"color: #2BA8FF\">/&gt;</span>\n\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;iframe</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">width</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"560\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">height</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"315\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.youtube.com/embed/pTGRpH2dvRM\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">frameborder</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"0\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">allow</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">allowfullscreen</span><span style=\"color: #2BA8FF\">&gt;&lt;/iframe&gt;</span>\n\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://www.emsifa.com/js/app.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">src</span><span style=\"color: #FFFFFF\">=</span><span style=\"color: #50E3C2\">\"https://cdnjs.cloudflare.com/jquery/jquery.min.js\"</span><span style=\"color: #2BA8FF\">&gt;&lt;/script&gt;</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">&lt;script&gt;alert</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'hello'</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #2BA8FF\">&lt;/script&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/body&gt;</span>\n<span style=\"color: #2BA8FF\">&lt;/html&gt;</span></code></pre>\n<p>Dari seluruh resource pada kode HTML diatas, hasilnya adalah seperti ini:</p>\n<ol>\n<li>style <code>https://www.emsifa.com/css/style.css</code>: ✔.</li>\n<li>style <code>https://cdnjs.cloudflare.com/bootstrap/css/bootstrap.min.css</code>: ❌.</li>\n<li>inline style <code>img {width: 100px}</code>: ❌.</li>\n<li>image <code>https://www.emsifa.com/img/logo.png</code>: ✔.</li>\n<li>image <code>https://www.w3schools.com/img/logo.png</code>: ❌.</li>\n<li>iframe <code>https://www.youtube.com/embed/pTGRpH2dvRM</code>: ✔.</li>\n<li>script <code>https://www.emsifa.com/js/app.js</code>: ✔.</li>\n<li>script <code>https://cdnjs.cloudflare.com/jquery/jquery.min.js</code>: ❌.</li>\n<li>inline script <code>alert('hello')</code>: ❌.</li>\n</ol>\n<h2 id=\"penutup\"><a href=\"#penutup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Penutup</h2>\n<p>Jadi seperti itulah <em>CSP</em>, bagaimana penulisannya, serta beberapa contohnya.\nArtikel ini saya adaptasi dari 2 link dibawah ini:</p>\n<ul>\n<li><a href=\"https://developers.google.com/web/fundamentals/security/csp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://developers.google.com/web/fundamentals/security/csp</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy</a></li>\n</ul>\n<p>Yaudah, sekian dulu artikel kali ini. Semoga bermanfaat, dah ~ </p>\n","excerpt":"","description":"Gunakan CSP untuk mencegah browser eksekusi script dari sumber yang tidak diinginkan","path":"/artikel/cegah-xss-dengan-csp/","cover":"/images/posts/csp-cover.png","icon":"/images/icons/www.png","tags":[{"id":"Web","title":"Web","path":"/tag/Web/"},{"id":"XSS","title":"XSS","path":"/tag/XSS/"}],"author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}},{"node":{"id":"0bce4c63aa0e0e74f4a7d378fafdb1ae","title":"Berkenalan dengan Rector — PHP Reconstructor Tool","datetime":"2019-12-21 11:00:00","content":"<p>Basa-basi dulu ya. Pernah nggak kamu develop suatu aplikasi, udah lama banget, lalu beberapa tahun kemudian kamu ditugaskan/ingin kembangkan source code aplikasi tersebut sekaligus ingin mengubah codebasenya menggunakan bahasa pemrograman atau framework yang terbaru (saat itu). Apa yang kamu lakukan? periksa filenya satu-persatu, ubah manual? ya, cara amannya memang begitu. Untuk beberapa <em>task</em> sederhana lain, kamu mungkin akan memanfaatkan fitur dari IDE/text-editor seperti <em>refactor</em>, <em>find-and-replace</em>, dsb.</p>\n<p>Nah, sekarang di PHP ada <em>tool</em> untuk membantu kamu melakukan hal tersebut, namanya <a href=\"https://github.com/rectorphp/rector\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>Rector</em></a> — PHP <strong><u>Rec</u></strong>onstruc<strong><u>tor</u></strong>.\n<em>Rector</em> adalah <em>open source command line tool</em> untuk membantu developer melakukan <em>upgrade</em> dan <em>refactoring</em> <em>codebase</em> PHP mereka secara instan. Sebelum kamu berharap dan membaca terlalu jauh, ini kata dokumentasi <em>Rector</em>: <em>\"Why refactor manually if Rector can handle 80% for you?\"</em>.</p>\n<p>Jadi, ya, <em>Rector</em> ini bukan <em>tool</em> ajaib yang bisa memenuhi 100% keinginanmu. Bahkan mungkin nggak sampai 80% kebutuhanmu seperti yang dokumentasinya bilang.</p>\n<p>Ok, lanjut ya?</p>\n<h2 id=\"apa-saja-yang-bisa-dilakukan-rector\"><a href=\"#apa-saja-yang-bisa-dilakukan-rector\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Apa Saja yang Bisa Dilakukan Rector?</h2>\n<p>Secara garis besar ya itu tadi, <em>upgrading</em> dan <em>refactoring</em>.\nMisal kamu mau upgrade project PHP 5.3 kamu ke PHP 7.4, <em>Rector</em> memiliki beberapa set <em>rector</em> untuk membantu kamu melakukan perubahan yang diperlukan. Atau kamu mau upgrade Laravel 5.5 ke Laravel 6, <em>Rector</em> juga punya beberapa set <em>rector</em> untuk melakukan hal tersebut.</p>\n<p>Ok, sebelum kebingungan ini \"berkembang biak\", jadi gini:</p>\n<ul>\n<li><em>Package Rector</em> memiliki beberapa \"<em>set</em>\".</li>\n<li>Setiap \"<em>set</em>\" terdiri dari beberapa \"<em>Rector</em>\".</li>\n</ul>\n<p><img src=\"/images/posts/black-guy-question-mark.jpeg\" alt=\"Black Guy question mark\"></p>\n<p>Intinya gini, <em>package</em> <em>Rector</em> ini berisi sekumpulan <em>Rector</em> <em>(class)</em> yang dikelompokkan kedalam <em>set</em>-nya masing-masing, dimana setiap <em>Rector</em>-nya bertanggung jawab untuk menangani sebuah <em>refactoring</em>. Seperti: mengubah nama fungsi dari <code>fn_a()</code> ke <code>fn_b()</code>, atau mengubah argumen dari <code>fn($x, $y)</code> menjadi <code>fn($y, $x)</code>, dan lain sebagainya.</p>\n<p>Kembali ke subtopik \"Apa Saja yang Bisa Dilakukan Rector?\". Sebetulnya banyak, karena <em>set</em>-nya itu banyak.\nJadi disini saya sebutkan yang sekiranya \"wah\" aja.</p>\n<ul>\n<li>Rector dapat mendeteksi dan memberikan <em>return type</em> pada <em>function</em> yang belum didefinisikan <em>return type</em>-nya.</li>\n<li>Rector dapat memberikan anotasi <code>@var</code> pada <em>property</em> yang belum kamu berikan <code>@var</code>.</li>\n<li>Mengubah penggunaan <em>facade</em> menjadi <em>dependency injection</em> pada kode Laravel kamu.</li>\n<li>Mengubah kode Nette menjadi kode Symfony (saya sendiri belum coba).</li>\n<li>Mengubah <code>$value = $a ? $a : null</code> menjadi <code>$value = $a ?: null</code>.</li>\n<li>Kalau kamu pernah mengalami error <code>count(): Parameter must be an array or an object that implements Countable</code>, ada Rector <code>CountOnNullRector</code> untuk mencegah hal tersebut dengan melakukan <em>safety check</em> terlebih dahulu.</li>\n</ul>\n<p>Masih banyak lagi sebetulnya, berikut <a href=\"https://github.com/rectorphp/rector/blob/master/docs/AllRectorsOverview.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">daftar sets dan Rector</a> lainnya yang dapat kamu gunakan (kayaknya belum lengkap).</p>\n<h2 id=\"cara-kerja-rector\"><a href=\"#cara-kerja-rector\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cara Kerja Rector</h2>\n<p>Untuk detil cara kerjanya kamu bisa lihat di <a href=\"https://github.com/rectorphp/rector/blob/master/docs/HowItWorks.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">halaman ini</a>. Disini saya hanya menuliskan garis besarnya supaya kamu setidaknya mendapat gambaran cara kerjanya.</p>\n<ol>\n<li>Pertama, <em>Rector</em> membaca file yang ingin diterapkan <em>refactoring</em> menggunakan <code>file_get_contents</code>. Dapatlah si Rector <em>string</em> yang berisi <em>source code</em> kamu.</li>\n<li>Kemudian <em>string</em> yang berisi <em>source code</em> tersebut di-<em>parsing</em> menggunakan <a href=\"https://github.com/nikic/PHP-Parser\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code>nikic/php-parser</code></a> menjadi <em>AST (Abstract Syntax Tree)</em>. Kalau kamu tidak tahu apa itu <em>AST</em>, anggap aja ini <em>JSON</em> yang berisi struktur <em>tree</em> dari <em>source code</em> kamu. <em>AST</em> tersebut berisi sekumpulan <em>node</em> yang saling terhubung, dimana setiap <em>node</em>-nya memiliki definisi <em>type</em>-nya, apakah dia <em>function</em>, <em>string</em>, <em>int</em>, <em>float</em>, <em>constant</em>, dsb. </li>\n<li>Setelah diparsing ke <em>AST</em>, <em>AST</em> tersebut dibaca <em>node-per-node</em>-nya, jika ada bagian yang perlu dilakukan <em>refactoring</em>, maka <em>node</em> input tersebut direkonstruksi menjadi <em>node</em> output.</li>\n<li>Kalau sudah selesai (semua <em>node</em> sudah dicek dan <em>Rector</em> yang digunakan sudah selesai melakukan rekonstruksi), <em>AST</em> hasil rekonstruksi tersebut akan diubah kembali menjadi <em>string</em> untuk disimpan ke file tersebut, atau sekedar ditampilkan perubahannya ke layar.</li>\n</ol>\n<h2 id=\"menggunakan-rector\"><a href=\"#menggunakan-rector\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Menggunakan Rector</h2>\n<p>Ada 2 cara instalasi <em>Rector</em>, yang pertama dengan <em>Docker</em>, yang ke-2 dengan <em>Composer</em>.\nDisini saya menggunakan cara yang lebih gampang jelasinnya, yaitu dengan <em>Composer</em>.</p>\n<h4 id=\"cek-requirements\"><a href=\"#cek-requirements\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Cek <em>Requirements</em></h4>\n<p>Oke, sebelum menggunakan <em>Rector</em>, pastikan kamu memenuhi kebutuhan dibawah ini:</p>\n<ol>\n<li>PHP >= 7.2 (cek dengan <code>php -v</code>).</li>\n<li>Ekstensi PHP JSON dan Tokenizer (bisa dicek dengan <code>php -m</code>).</li>\n<li><a href=\"https://getcomposer.org\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Composer</a> (cek dengan <code>composer --version</code>).</li>\n</ol>\n<blockquote>\n<p>Versi <em>Rector</em> yang saya gunakan disini adalah versi <code>0.6.2</code>, jika kamu adalah manusia dari masa depan yang sedang membaca artikel ini di versi <em>Rector</em> yang lebih tinggi, mungkin <em>requirement</em> diatas bisa berubah atau bertambah.</p>\n</blockquote>\n<h4 id=\"menginstall-rector\"><a href=\"#menginstall-rector\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Menginstall <em>Rector</em></h4>\n<p>Pada saat saya menulis artikel ini, <em>Rector</em> masih bermasalah jika diinstall secara global menggunakan <code>composer global require</code>, jadi kita akan menginstallnya ke direktori khusus dengan perintah <code>composer require</code> biasa. Berikut <em>step-by-step</em>-nya:</p>\n<ol>\n<li>Buka terminal/cmd.</li>\n<li>\n<p>Buat dan masuk ke direktori manapun dimana kamu ingin menginstall <em>Rector</em>.\nContoh saya akan menginstall <em>Rector</em> di <code>~/dev/tools/rector</code>, maka perintah (linux) yang saya gunakan adalah:</p>\n<ul>\n<li><code>mkdir ~/Dev/rector -P</code> (buat direktorinya).</li>\n<li><code>cd ~/Dev/rector</code> (masuk ke direktorinya).</li>\n</ul>\n</li>\n<li>Install <em>Rector</em>: <code>composer require rector/rector --dev</code>.</li>\n<li>Cek instalasi: <code>./vendor/bin/rector --version</code>. Kalu muncul output seperti ini: <code>Rector v0.6.2</code> artinya instalasinya berhasil.</li>\n</ol>\n<p>Sampai sini kita sudah dapat menggunakan <em>Rector</em>, tapi saya mau jelaskan dulu strategi seperti apa yang akan kita gunakan.\nJadi dengan cara instalasi seperti ini (menggunakan <code>composer require</code>), saya memikirkan setidaknya ada 3 strategi yang dapat kamu lakukan:</p>\n<ol>\n<li>Menginstall <em>Rector</em> di setiap project kamu.</li>\n<li>Menaruh <em>source code</em> project yang ingin dilakukan <em>refactoring</em> kedalam direktori rector.</li>\n<li>Mendaftarkan <code>~/Dev/rector/vendor/bin</code> kedalam variable <code>PATH</code> untuk mengglobalkan perintah <code>rector</code>.</li>\n</ol>\n<p>Saya tidak menyarankan cara pertama, karena buat apa juga install <em>Rector</em> banyak-banyak, toh fungsinya sama.\nSedangkan untuk cara ke-2 dan ke-3, untuk penggunaan berkepanjangan saya lebih menyarankan cara ke-3. Tapi pada artikel ini, kita akan menggunakan cara ke-2 karena lebih mudah dan <em>to-the-point</em>.</p>\n<p>Jadi kita akan menaruh <em>source code</em> yang akan kita lakukan <em>refactoring</em> kedalam direktori <code>~/Dev/rector/src</code>.\nMisal kamu ingin <em>refactor</em> project Laravel kamu, kamu bisa menaruhnya ke <code>~/Dev/rector/src/project-laravelmu</code>.</p>\n<h4 id=\"melihat-set-yang-tersedia\"><a href=\"#melihat-set-yang-tersedia\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Melihat <em>Set</em> yang Tersedia</h4>\n<p>Sebelum kita melakukan <em>refactoring</em>, kita dapat mengecek terlebih dahulu <em>set</em> yang tersedia pada instalasi <em>Rector</em> kita.\nMasih di terminal, ketikkan:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">./vendor/bin/rector sets</span></code></pre>\n<p>Outputnya kurang lebih akan seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">Rector v0.6.2</span>\n\n<span style=\"color: #FFFFFF\">116 available sets:</span>\n<span style=\"color: #FFFFFF\">===================</span>\n\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> action-injection-to-constructor-injection</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> array-str-functions-to-static-call       </span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp34</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp35</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp36</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp37</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp38</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> cakephp40</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> celebrity</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> code-quality</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> coding-style</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> constructor-injectin-to-action-injection </span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> contributte-to-symfony</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> dead-code</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> doctrine</span>\n<span style=\"color: #FFFFFF\"> ... masih banyak lagi</span></code></pre>\n<p>Itu adalah daftar <em>set</em> yang bisa kamu gunakan untuk tahap selanjutnya. Seperti yang saya bilang sebelumnya, setiap <em>set</em> terdiri dari sekumpulan <em>Rector</em> untuk melakukan <em>refactoring</em> yang berbeda-beda.</p>\n<p>Kalau kamu ingin mengecek ketersediaan <em>set</em> tertentu, contoh kamu ingin melihat <em>set</em> yang berhubungan sama Laravel,\nkamu bisa gunakan perintah dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">./vendor/bin/rector sets laravel</span></code></pre>\n<p>Maka outputnya akan difiltrasi seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">Rector v0.6.2</span>\n\n<span style=\"color: #FFFFFF\">11 available sets:</span>\n<span style=\"color: #FFFFFF\">==================</span>\n\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel-static-to-injection</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel50</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel51</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel52</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel53</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel54</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel55</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel56</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel57</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel58</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> laravel60</span></code></pre>\n<blockquote>\n<p>Sayangnya pada versi <code>0.6.2</code> yang saya install ini, kita belum bisa melihat <em>Rector</em> apa saja pada masing-masing <em>set</em> tersebut.\nJadi jika kamu ingin melihat <em>Rector</em> pada setiap <em>set</em>, untuk sementara kamu dapat melihatnya pada <a href=\"https://github.com/rectorphp/rector/blob/master/docs/AllRectorsOverview.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">halaman ini</a>.</p>\n</blockquote>\n<h4 id=\"mengaplikasikan-set-dengan-1-perintah\"><a href=\"#mengaplikasikan-set-dengan-1-perintah\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Mengaplikasikan <em>Set</em> dengan 1 Perintah</h4>\n<p>Ini adalah cara penggunaan <em>Rector</em> yang paling sederhana.\nMisalkan disini saya akan mencoba <em>set</em> <code>php70</code> dimana salah satu <em>Rector</em>-nya adalah <code>TernaryToNullCoalescingRector</code>,\nyakni mengubah <a href=\"https://www.php.net/manual/en/language.operators.comparison.php#language.operators.comparison.ternary\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>Ternary Operator</em></a> menjadi <a href=\"language.operators.comparison.coalesce\"><em>Null Coalescing Operator</em></a>.</p>\n<p>Pertama saya membuat file <code>src/sample.php</code>. Lalu saya isikan kode sebagai berikut:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">[filename:~/Dev/rector/src/sample.php]</span>\n<span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">keyword </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">isset</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">_GET</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">'q'</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">) ? </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">_GET</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">'q'</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> : </span><span style=\"color: #50E3C2\">''</span><span style=\"color: #EFEFEF\">;</span></code></pre>\n<p>Untuk menerapkan <em>set</em> <code>php70</code> pada (seluruh file <code>.php</code> di) direktori <code>src</code>, kita dapat gunakan perintah dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">./vendor/bin/rector process --set php70 src</span></code></pre>\n<p>Maka <em>Rector</em> akan menampilkan perubahan apa saja yang dia lakukan, dan menyimpan perubahannya ke file tersebut.\nKalau kamu lihat kembali isi file <code>src/sample.php</code>, kode yang sebelumnya kita buat akan berubah menjadi seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">[filename:~/Dev/rector/src/sample.php]</span>\n<span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">keyword </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">_GET</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">'q'</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> ?? </span><span style=\"color: #50E3C2\">''</span><span style=\"color: #EFEFEF\">;</span></code></pre>\n<p>Jika kamu menginginkan <em>Rector</em> hanya menampilkan perubahannya tanpa menyimpan perubahan ke masing-masing file,\nkamu dapat gunakan opsi <code>--dry-run</code> atau <code>-n</code> seperti dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">./vendor/bin/rector process --set php70 --dry-run src</span></code></pre>\n<p>Maka <em>Rector</em> hanya akan menampilkan perubahannya saja, tanpa menyimpan perubahan tersebut ke setiap filenya.</p>\n<h4 id=\"menerapkan-beberapa-set-sekaligus-dengan-rectoryaml\"><a href=\"#menerapkan-beberapa-set-sekaligus-dengan-rectoryaml\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Menerapkan Beberapa Set Sekaligus dengan <code>rector.yaml</code></h4>\n<p>Sebelumnya kita menerapkan <em>set</em> dengan sebuah perintah.\nBagaimana jika kita ingin menerapkan beberapa <em>set</em> sekaligus? jawabannya adalah file <code>rector.yaml</code>.</p>\n<p>File <code>rector.yaml</code> adalah file konfigurasi <em>Rector</em> yang kita siapkan untuk project tertentu.\nJadi setiap project bisa beda-beda file <code>rector.yaml</code>-nya. Untuk namanya sebetulnya tidak harus <code>rector.yaml</code>,\njadi misalkan kamu punya konfigurasi berbeda antara project A dan project B, kamu bisa bedakan namanya, misal <code>rector-a.yaml</code>, dan <code>rector-b.yaml</code>. Hanya saja secara default <em>Rector</em> akan menggunakan file <code>rector.yaml</code> yang pada direktori\ndimana kamu menjalankan perintah <code>rector</code>.</p>\n<p>Pada file <code>rector.yaml</code> ini kita bisa spesifikasikan beberapa hal, seperti <em>sets</em> yang ingin digunakan,\nfile autoloading tambahan, path pengecualian, dsb.\nTapi bakal panjang kalau saya contohin satu-persatu,\njadi disini saya contohin cara menerapkan beberapa <em>sets</em> sekaligus aja.</p>\n<p>Oke, jadi pertama-tama saya siapkan dulu contoh file yang mau di-<em>refactoring</em>-nya.\nSaya ubah <code>src/sample.php</code> menjadi seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">[filename:~/Dev/rector/src/sample.php]</span>\n<span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #FF0078\">try</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">isset</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">) ? </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> : </span><span style=\"color: #2BA8FF\">null</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #EFEFEF\">!$</span><span style=\"color: #FFFFFF\">filename) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FF0078\">throw</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Missing filename\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">json </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">json_decode</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">file_get_contents</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">dirname</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">__FILE__</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #50E3C2\">'/'</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename))</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FAC863\">print_r</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">json)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #2BA8FF\">JsonException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FAC863\">echo</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">getMessage()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FAC863\">echo</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">getMessage()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Misalkan saya ingin menerapkan 3 buah set, yakni set <code>php53</code>, <code>php70</code> dan <code>php71</code>.\nJadi mari kita buat file <code>rector.yaml</code> seperti dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">filename:~/Dev/rector/rector.yaml</span><span style=\"color: #EFEFEF\">]</span>\n<span style=\"color: #2BA8FF\">parameters</span><span style=\"color: #EFEFEF\">:</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">sets</span><span style=\"color: #EFEFEF\">:</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">- </span><span style=\"color: #50E3C2\">php53</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">- </span><span style=\"color: #50E3C2\">php70</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">- </span><span style=\"color: #50E3C2\">php71</span></code></pre>\n<p>Selanjutnya mari kita cek dulu apa saja yang akan dirubah dengan perintah:</p>\n<code class=\"shiki\" style=\"background: #2e3440; color: #d8dee9\">./vendor/bin/rector process --dry-run src</code>\n<p>Outputnya akan seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">Rector v0.6.2</span>\n<span style=\"color: #FFFFFF\">Config file: rector.yaml</span>\n\n<span style=\"color: #FFFFFF\">3/3 [============================] 100%</span>\n\n<span style=\"color: #FFFFFF\">1 file with changes</span>\n<span style=\"color: #FFFFFF\">===================</span>\n\n<span style=\"color: #FFFFFF\">1) src/sample.php</span>\n\n<span style=\"color: #FFFFFF\">  ---------- begin diff ----------</span>\n<span style=\"color: #FFFFFF\">--- Original</span>\n<span style=\"color: #FFFFFF\">+++ New</span>\n<span style=\"color: #FFFFFF\">@@ -1,13 +1,13 @@</span>\n<span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">InvalidArgumentException</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> JsonException</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FF0078\">try</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">isset</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">) ? </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> : </span><span style=\"color: #2BA8FF\">null</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> ?? </span><span style=\"color: #2BA8FF\">null</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">     </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #EFEFEF\">!$</span><span style=\"color: #FFFFFF\">filename) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">         </span><span style=\"color: #FF0078\">throw</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"missing filename\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">     </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">json </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">json_decode</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">file_get_contents</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">dirname</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">__FILE__</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #50E3C2\">'/'</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename))</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #2BA8FF\">JsonException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">json </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">json_decode</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">file_get_contents</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">__DIR__</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #50E3C2\">'/'</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename))</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (JsonException|</span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">     </span><span style=\"color: #FAC863\">echo</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">getMessage()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\">    </span><span style=\"color: #FAC863\">echo</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">getMessage()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">-</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #EFEFEF\">+</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">\\ </span><span style=\"color: #2BA8FF\">No</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">newline</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">at</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">end</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">of</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">file</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">-----------</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">end</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">diff</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">-----------</span>\n\n<span style=\"color: #5392DB\">Applied</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">rules</span><span style=\"color: #FFFFFF\">:</span>\n\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Php71</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">TryCatch</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #5392DB\">MultiExceptionCatchRector</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Php70</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Ternary</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #5392DB\">TernaryToNullCoalescingRector</span>\n<span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">*</span><span style=\"color: #FFFFFF\"> Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Php53</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Rector</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">FuncCall</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #5392DB\">DirNameFileConstantToDirConstantRector</span>\n\n\n<span style=\"color: #EFEFEF\">[</span><span style=\"color: #5392DB\">OK</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">Rector</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">is</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">done</span><span style=\"color: #EFEFEF\">!</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">changed</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #5392DB\">files</span><span style=\"color: #FFFFFF\">                                                                         </span></code></pre>\n<p>Disitu bisa kita lihat bagian-bagian yang ditambah dan dihapus.\nJuga pada bagian bawah kita dapat lihat ada 3 <em>Rector</em> yang digunakan, yaitu:</p>\n<ol>\n<li><code>Rector\\Php71\\Rector\\TryCatch\\MultiExceptionCatchRector</code> dari set <code>php71</code>.</li>\n<li><code>Rector\\Php70\\Rector\\Ternary\\TernaryToNullCoalescingRector</code> dari set <code>php70</code>.</li>\n<li><code>Rector\\Php53\\Rector\\FuncCall\\DirNameFileConstantToDirConstantRector</code> dari set <code>php53</code>.</li>\n</ol>\n<p>Kalau sekiranya oke, mari kita aplikasikan ke filenya dengan menghapuskan <code>--dry-run</code> seperti dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">./vendor/bin/rector process src</span></code></pre>\n<p>Sekarang, kalau kita lihat filenya, maka akan jadi seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">[filename:~/Dev/rector/src/sample.php]</span>\n<span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">InvalidArgumentException</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> JsonException</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FF0078\">try</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">argv</span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #2BA8FF\">1</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\"> ?? </span><span style=\"color: #2BA8FF\">null</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #EFEFEF\">!$</span><span style=\"color: #FFFFFF\">filename) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FF0078\">throw</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"missing filename\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">json </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">json_decode</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FAC863\">file_get_contents</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">__DIR__</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #50E3C2\">'/'</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename))</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">catch</span><span style=\"color: #FFFFFF\"> (JsonException|</span><span style=\"color: #2BA8FF\">InvalidArgumentException</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FAC863\">echo</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">e</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">getMessage()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<h2 id=\"penutup\"><a href=\"#penutup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Penutup</h2>\n<p>Oke mungkin segitu saja untuk artikel pengenalan <em>Rector</em> kali ini.\nKarena <em>tool</em> ini umurnya masih terbilang baru, jadi memang mungkin belum banyak yang bisa kita lakukan.\nTapi kedepan mungkin akan banyak tambahan-tambahan <em>Rector</em> lain yang dapat membantu <em>task</em> <em>refactoring</em> kita.\nJadi tidak ada salahnya kita pelajari sejak awal.</p>\n<p>Yaudah, sekian untuk artikel kali ini. Semoga bermanfaat. Dadah ~</p>\n","excerpt":"","description":"Upgrade dan refactoring kode PHP kamu secara instan","path":"/artikel/berkenalan-dengan-rector/","cover":"/images/posts/rector-cover.png","icon":"/images/icons/php.png","tags":[{"id":"PHP","title":"PHP","path":"/tag/PHP/"},{"id":"Rector","title":"Rector","path":"/tag/Rector/"}],"author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}},{"node":{"id":"b86316117b02f0df7b890fc2071827cc","title":"Membuat API Rate Limiting menggunakan Redis pada Express.js","datetime":"2019-12-01 11:00:00","content":"<p>Beberapa waktu yang lalu, saya sempat menuliskan catatan kursus Redis saya di <a href=\"university.redislabs.com/\">Redis University</a>. Tapi catatannya tidak saya lanjutkan karena <del>materi yang dibahas antar kelas yang satu dengan kelas yang lainnya banyak yang mirip-mirip</del> saya malas. Sebagai gantinya, saya akan menuliskan beberapa artikel Redis yang sekiranya banyak dibutuhkan oleh industri. Salah satunya adalah Rate Limiting ini.</p>\n<p>Rate Limiting (dalam konteks aplikasi web) adalah proses membatasi jumlah request user/client pada resource tertentu. Sebagai contoh disini kita akan coba membatasi akses user terhadap API yang dibuat menggunakan Express.js pada setiap menitnya.</p>\n<p>Sebelum mencoba ini, pastikan kamu sudah menginstall <strong><a href=\"https://redis.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redis</a></strong> dan <strong><a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Node.js</a></strong> terlebih dahulu. Pada tutorial ini saya menggunakan Node.js versi 10.15.3 dan Redis versi 5.0.5. Buat kamu yang pakai Windows seperti saya, kamu dapat menjalankan Redis dengan Docker.</p>\n<h2 id=\"kenapa-redis\"><a href=\"#kenapa-redis\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Kenapa Redis?</h2>\n<p>Untuk membuat Rate Limiting kita bisa saja menggunakan NginX atau session.\nTapi kenapa Redis?</p>\n<ul>\n<li>Dibandingkan dengan NginX, Rate Limiting menggunakan Redis lebih fleksibel karena kita sendiri yang mengatur logic dari Rate Limiternya.</li>\n<li>Performa Redis yang menggunakan penyimpanan pada RAM lebih cepat ketimbang session yang (biasanya) menggunakan file atau database lain yang menggunakan penyimpanan fisik.</li>\n<li>Redis mendukung banyak platform dan memiliki ketersediaan library di berbagai bahasa pemrograman.</li>\n</ul>\n<h2 id=\"persiapan\"><a href=\"#persiapan\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Persiapan</h2>\n<p>Saya akan <em>to-the-point</em> aja disini, kalau bingung silahkan tanya saya via <a href=\"https://www.facebook.com/em.sifa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">facebook</a>.</p>\n<ul>\n<li>Buka terminal atau cmd (selanjutnya saya akan sebut terminal aja).</li>\n<li>Buat direktori baru: <code>mkdir express-rate-limiting</code>.</li>\n<li>Masuk ke direktori tersebut: <code>cd express-rate-limiting</code>.</li>\n<li>Inisiasi file package.json: <code>npm init -y</code>.</li>\n<li>Install package yang dibutuhkan: <code>npm i -S express redis bluebird date-fns</code>.</li>\n<li>Buka terminal lain, jalankan redis-server.</li>\n</ul>\n<p>Berikut sedikit penjelasan tentang package yang kita install diatas:</p>\n<ul>\n<li><code>express</code>: untuk membuat Web API.</li>\n<li><code>redis</code>: untuk koneksi dan mengirim perintah ke redis server.</li>\n<li><code>bluebird</code>: untuk membuat versi Promise pada setiap API/function di package redis.</li>\n<li><code>date-fns</code>: untuk format tanggal.</li>\n</ul>\n<h2 id=\"konsep\"><a href=\"#konsep\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Konsep</h2>\n<p>Goal pada aplikasi yang akan kita buat disini adalah untuk\nmembatasi akses ke endpoint <code>GET /hello</code> supaya setiap IP\nhanya dapat mengakses sebanyak 10 kali saja setiap menitnya.</p>\n<p>Untuk mencapai goal tersebut, kita akan memanfaatkan 3 perintah redis, yaitu:</p>\n<ul>\n<li><code>GET</code>: untuk mengambil nilai dari key.</li>\n<li><code>INCR</code>: untuk increment nilai numerik dari key.</li>\n<li><code>EXPIRE</code>: untuk set expiration key supaya nilai dari keynya otomatis hilang dalam kurun waktu tertentu, sehingga tidak membebani memori berkepanjangan. Istilah kerennya <em>time-based retention</em>.</li>\n</ul>\n<p>Pemanfaatannya adalah sebagai berikut:</p>\n<ul>\n<li>Ambil jumlah akses (nilai numerik) dari key menggunakan <code>GET</code>.</li>\n<li>\n<p>Jika jumlah akses melebihi batas (10):</p>\n<ul>\n<li>Kirim response error 429 (Too Many Requests).</li>\n</ul>\n</li>\n<li>\n<p>Jika jumlah akses dibawah atau sama dengan batas (10):</p>\n<ul>\n<li>Increment nilai dari key menggunakan <code>INCR</code>.</li>\n<li>Set expire dari key menggunakan <code>EXPIRE</code>.</li>\n<li>Kirim response sukses.</li>\n</ul>\n</li>\n</ul>\n<p>Supaya <u>setiap IP</u> hanya boleh mengakses <u>path tertentu</u> pada <u>setiap menitnya</u>.\nKita akan membuat keynya dengan format seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span><span style=\"color: #5392DB\">IP</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">:</span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #5392DB\">PATH</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">:</span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #5392DB\">TAHUN</span><span style=\"color: #EFEFEF\">}{</span><span style=\"color: #5392DB\">BULAN</span><span style=\"color: #EFEFEF\">}{</span><span style=\"color: #5392DB\">TANGGAL</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">:</span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #5392DB\">JAM</span><span style=\"color: #EFEFEF\">}{</span><span style=\"color: #5392DB\">MENIT</span><span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Contoh jika IP <code>1.2.3.4</code> mengakses <code>\"/hello\"</code> pada <code>2019-12-01 10:15:25</code>. Keynya akan seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">1.2.3.4:/hello:20191201:1015</span></code></pre>\n<p>Sebagai gambaran, berikut adalah table skenario request yang dijalankan oleh <code>1.2.3.4</code> ke path <code>/hello</code> pada waktu tertentu:</p>\n<div class=\"table-responsive\">\n<table>\n<thead>\n<tr>\n<th align=\"center\"><strong>No.</strong></th>\n<th align=\"center\"><strong>Waktu</strong></th>\n<th align=\"center\"><strong>Key</strong></th>\n<th align=\"center\"><strong>Value</strong></th>\n<th align=\"center\"><strong>Hasil</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">1</td>\n<td align=\"center\">2019-12-01 10:01:00</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">1</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">2</td>\n<td align=\"center\">2019-12-01 10:01:01</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">2</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">3</td>\n<td align=\"center\">2019-12-01 10:01:05</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">3</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\">2019-12-01 10:01:12</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">4</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">5</td>\n<td align=\"center\">2019-12-01 10:01:16</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">5</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\">2019-12-01 10:01:18</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">6</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">7</td>\n<td align=\"center\">2019-12-01 10:01:19</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">7</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">8</td>\n<td align=\"center\">2019-12-01 10:01:21</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">8</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">9</td>\n<td align=\"center\">2019-12-01 10:01:25</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">9</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">10</td>\n<td align=\"center\">2019-12-01 10:01:30</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">10</td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n<tr>\n<td align=\"center\">11</td>\n<td align=\"center\">2019-12-01 10:01:36</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">11</td>\n<td align=\"center\"><strong class=\"text-red-500\">error</strong></td>\n</tr>\n<tr>\n<td align=\"center\">12</td>\n<td align=\"center\">2019-12-01 10:01:40</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:1001</td>\n<td align=\"center\">11</td>\n<td align=\"center\"><strong class=\"text-red-500\">error</strong></td>\n</tr>\n<tr>\n<td align=\"center\">13</td>\n<td align=\"center\">2019-12-01 10:<strong class=\"bg-gray-200 text-gray-800\">02</strong>:05</td>\n<td align=\"center\">1.2.3.4:/hello:20191201:10<strong class=\"bg-gray-200 text-gray-800\">02</strong></td>\n<td align=\"center\"><strong class=\"bg-gray-200 text-gray-800\">1</strong></td>\n<td align=\"center\"><strong class=\"text-green-500\">sukses</strong></td>\n</tr>\n</tbody>\n</table>\n</div>\n<h2 id=\"implementasi\"><a href=\"#implementasi\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Implementasi</h2>\n<p>Sekarang saatnya masuk ke <em>text editor</em> atau <em>IDE</em> favorit kamu.\nPertama-tama silahkan buat file <code>app.js</code> pada direktori yang sama dengan file <code>package.json</code>.\nLalu kita akan masuk ke tahap berikutnya.</p>\n<h4 id=\"1-import-package\"><a href=\"#1-import-package\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>1. Import Package</h4>\n<p>Sebelum menuliskan <em>app logic</em>-nya, mari kita import dulu <em>package</em> yang sudah kita install sebelumnya.</p>\n<p>Isikan kode seperti dibawah ini pada file <code>app.js</code> kamu:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<h4 id=\"2-promisify\"><a href=\"#2-promisify\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>2. Promisify</h4>\n<p>Pada tahap ini kita akan menggunakan bluebird untuk menambahkan <em>Promise-based</em> function pada setiap API/function yang tersedia pada <em>package</em> redis.</p>\n<p>Silahkan tambahkan baris berikut setelah <em>require-require</em> sebelumnya.</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span></code></pre>\n<blockquote>\n<p>Promise-based function berfungsi untuk menghindari <a href=\"http://callbackhell.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">callback-hell</a></p>\n</blockquote>\n<h4 id=\"3-membuat-dan-menghubungkan-redis-client\"><a href=\"#3-membuat-dan-menghubungkan-redis-client\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>3. Membuat dan Menghubungkan Redis Client</h4>\n<p>Selanjutnya, untuk dapat mengirimkan perintah ke redis-server, kita perlu membuat dan menghubungkan redis client terlebih dahulu.</p>\n<p>Tambahkan baris berikut dibawah tahap sebelumnya:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<p>Kalau sudah, kamu dapat test koneksi menggunakan terminal dengan perintah:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">node app</span></code></pre>\n<p>Tunggu sebentar, kalau muncul error <code>ECONNREFUSED</code>, kemungkinannya:</p>\n<ul>\n<li>Redis server belum running</li>\n<li>Hostnya salah</li>\n<li>Portnya salah</li>\n</ul>\n<p>Silahkan cek dan sesuaikan lagi.</p>\n<h4 id=\"4-inisiasi-express-app\"><a href=\"#4-inisiasi-express-app\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>4. Inisiasi Express App</h4>\n<p>Setelah koneksi redis client berhasil, saatnya kita membuat aplikasi webnya.</p>\n<p>Lanjut dibawah kode sebelumnya. Ketikkan kode berikut:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<hr>\n<details><summary>Kode keseluruhan pada tahap ini:</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<h4 id=\"5-menerapkan-rate-limiting-pada-endpoint-get-hello\"><a href=\"#5-menerapkan-rate-limiting-pada-endpoint-get-hello\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>5. Menerapkan Rate Limiting pada Endpoint \"GET /hello\"</h4>\n<p>Pada tahap ini kita akan memanfaatkan redis client untuk membatasi akses ke endpoint <code>GET /hello</code>\nsupaya setiap IP hanya dapat mengakses sebanyak 10 kali saja pada setiap menitnya.</p>\n<p>Silahkan ubah <code>app.get('/hello', ...)</code> pada tahap sebelumnya menjadi seperti ini (pahami penjelasan baris-per-baris):</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> limit </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">      </span><span style=\"color: #888\">// limit akses setiap menitnya</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> path </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #888\">// path dari API</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">) </span><span style=\"color: #888\">// waktu untuk dijadikan key  </span>\n<span style=\"color: #FFFFFF\">  </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Set redis key yang digunakan untuk menyimpan </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// jumlah akses oleh IP: req.ip, untuk path: path, pada menit: time</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span><span style=\"color: #FFFFFF\"> </span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Ambil jumlah akses saat ini</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kalau jumlah akses melebihi limit ...</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">      </span><span style=\"color: #888\">// ... kirim response error 429</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Jalankan transaction untuk:</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> trx </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)         </span><span style=\"color: #888\">// 1. increment key</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)   </span><span style=\"color: #888\">// 2. set expire key 60 detik</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kirim response yang seharusnya</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n<p>Hmm, panjang juga ya. Kalau belum paham, baca ulang lagi aja sampai paham.</p>\n<p>Pada saat mengeset variable <code>key</code>, kamu dapat sesuaikan sesuai kebutuhan kamu.\nMisal untuk IP diatas dapat kamu ganti dengan token.\nAtau misal kamu mau batasinya per jam, kamu dapat ubah format<code>time</code>-nya menjadi <code>yyyyMMdd:HH</code> aja.\nAtau misalkan lagi kamu mau batasi secara global, bukan hanya pada path <code>/hello</code> aja,\nkamu dapat hilangkan informasi <code>path</code> pada <code>key</code>-nya.</p>\n<hr>\n<details><summary>Kode keseluruhan pada tahap ini:</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> limit </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">      </span><span style=\"color: #888\">// limit akses setiap menitnya</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> path </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #888\">// path dari API</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">) </span><span style=\"color: #888\">// waktu untuk dijadikan key  </span>\n<span style=\"color: #FFFFFF\">  </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Set redis key yang digunakan untuk menyimpan </span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// jumlah akses oleh IP: req.ip, untuk path: path, pada menit: time</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span><span style=\"color: #FFFFFF\"> </span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Ambil jumlah akses saat ini</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kalau jumlah akses melebihi limit ...</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">    </span><span style=\"color: #888\">// ... kirim response error 429</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">      message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Jalankan transaction untuk:</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> trx </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)         </span><span style=\"color: #888\">// 1. increment key</span>\n<span style=\"color: #FFFFFF\">  trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)   </span><span style=\"color: #888\">// 2. set expire key 60 detik</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> trx</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #EFEFEF\">  </span><span style=\"color: #888\">// Kirim response yang seharusnya</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<h4 id=\"6-cobain\"><a href=\"#6-cobain\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>6. Cobain</h4>\n<p>Sampai sini, rate limiting kita sudah jadi.\nSilahkan jalankan kembali perintah <code>node app</code> pada terminal.\nKemudian buka web browser, bukalah URL <code>http://localhost:3000/hello</code>.</p>\n<p>Seharusnya, pada 10 request pertama kamu akan mendapatkan response seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"Hello World\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Sedangkan pada request selanjutnya, kamu akan mendapatkan response seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"error\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"API rate limit exceeded\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Lalu coba tunggu 1 menit, kemudian akses <code>/hello</code> lagi. Responsenya akan kembali seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">\"message\"</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FFF\">\"Hello World\"</span>\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Artinya rate-limiting kita sudah berhasil membatasi 10 kali akses pada setiap menitnya.</p>\n<h2 id=\"penutup\"><a href=\"#penutup\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Penutup</h2>\n<p>Sampai sini saya harap kamu sudah paham tentang Rate Limiting, serta penerapan Rate Limiting menggunakan Redis (khususnya) pada Express.js. Untuk bahasa dan framework lain, tahapannya kurang/lebih sama.\nYaitu kamu cukup memanfaatkan perintah <code>get</code>, <code>incr</code> dan <code>expire</code> pada Redis client di bahasa/framework itu.</p>\n<p>Sebagai bonus, dibawah ini saya lampirkan kode middleware dari penerapan Rate Limiting kita diatas.\nDengan middleware ini, kamu dapat menerapkan rate-limiting ke berbagai endpoint cukup dengan 1 baris pemanggilan fungsi middleware ini.</p>\n<hr>\n<details><summary>BONUS</summary>\n<p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span><span style=\"color: #FFFFFF\"> format </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'date-fns'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> express </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'express'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> bluebird </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'bluebird'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> redis </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">require</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'redis'</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #FFFFFF\">bluebird</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">promisifyAll</span><span style=\"color: #FFFFFF\">(redis)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> client </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> redis</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">createClient</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  host</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'127.0.0.1'</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">  port</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">6379</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> port </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">3000</span><span style=\"color: #FFFFFF\">     </span><span style=\"color: #888\">// definisikan port</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> app </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">express</span><span style=\"color: #FFFFFF\">() </span><span style=\"color: #888\">// inisiasi web app</span>\n\n<span style=\"color: #888\">// Middleware rate limit per menit</span>\n<span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">rateLimitPerMinute</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">limit</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> path</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> next</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> time </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">format</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">new</span><span style=\"color: #FFFFFF\"> Date()</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'yyyyMMdd:HHmm'</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> key </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">ip</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">path </span><span style=\"color: #EFEFEF\">||</span><span style=\"color: #FFFFFF\"> req</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FFFFFF\">path</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">:</span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">time</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">`</span>\n<span style=\"color: #FFFFFF\">    </span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> count </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">parseInt</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">getAsync</span><span style=\"color: #FFFFFF\">(key))</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">if</span><span style=\"color: #FFFFFF\"> (count </span><span style=\"color: #EFEFEF\">&gt;</span><span style=\"color: #FFFFFF\"> limit) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">      </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">status</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        error</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">429</span><span style=\"color: #EFEFEF\">,</span>\n<span style=\"color: #FFFFFF\">        message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">`API rate limit exceeded`</span>\n<span style=\"color: #FFFFFF\">      </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #FFFFFF\">    </span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">const</span><span style=\"color: #FFFFFF\"> mul </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> client</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">multi</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">    mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">incr</span><span style=\"color: #FFFFFF\">(key)</span>\n<span style=\"color: #FFFFFF\">    mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">expire</span><span style=\"color: #FFFFFF\">(key</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">60</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #FF0078\">await</span><span style=\"color: #FFFFFF\"> mul</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">execAsync</span><span style=\"color: #FFFFFF\">()</span>\n\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">next</span><span style=\"color: #FFFFFF\">()</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #888\">// Daftarkan endpoint \"GET /hello\"</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">get</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">'/hello'</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">rateLimitPerMinute</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #2BA8FF\">10</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">async</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">(</span><span style=\"color: #FFFFFF\">req</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> res</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  res</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">json</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">    message</span><span style=\"color: #EFEFEF\">:</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">'Hello world'</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span>\n\n<span style=\"color: #888\">// Jalankan web app</span>\n<span style=\"color: #FFFFFF\">app</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #2BA8FF\">listen</span><span style=\"color: #FFFFFF\">(port</span><span style=\"color: #EFEFEF\">,</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">  </span><span style=\"color: #2BA8FF\">console</span><span style=\"color: #EFEFEF\">.</span><span style=\"color: #FAC863\">log</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">`App listening on port </span><span style=\"color: #EFEFEF\">${</span><span style=\"color: #FFFFFF\">port</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">!`</span><span style=\"color: #FFFFFF\">)</span>\n<span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">)</span></code></pre>\n</p>\n</details>\n<hr>\n<p>Yaudah sekian dulu artikel kali ini. Semoga bermanfaat. Dadah ~</p>\n","excerpt":"","description":"Membatasi jumlah akses API setiap menitnya menggunakan Redis pada Express.js.","path":"/artikel/membuat-api-rate-limiting-redis-express/","cover":"/images/posts/membuat-api-rate-limiting-redis-express.png","icon":"/images/icons/redis.png","tags":[{"id":"Express.js","title":"Express.js","path":"/tag/Express.js/"},{"id":"Node","title":"Node","path":"/tag/Node/"},{"id":"Redis","title":"Redis","path":"/tag/Redis/"}],"author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}},{"node":{"id":"80040c8d50366162db3f400b81efbfdc","title":"Export Jutaan Data ke CSV dengan Aman di Laravel","datetime":"2019-11-08 11:00:00","content":"<p>Pada versi 6.0, Laravel menambahkan sebuah fitur baru yaitu <em>Lazy Collection</em>.\nDengan <em>Lazy Collection</em>, aplikasi Laravel dapat mengambil sekumpulan data dari database\ntanpa harus menampung <strong>seluruh</strong> data tersebut kedalam memori. Di balik layar, <em>Lazy Collection</em>\nmemanfaatkan fitur <em>PHP Generator</em>. Beberapa waktu lalu, saya posting <a href=\"https://www.facebook.com/em.sifa/videos/vb.100000130485713/3270308866316764/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">video</a> untuk menjelaskan bagaimana generator dapat menghemat penggunaan memori,\nvideo berdurasi 20 menitan tersebut dapat membantu kamu untuk lebih memahami apa yang saya tuliskan disini.</p>\n<p>Pada artikel ini, saya mau share bagaimana cara memanfaatkan <em>Lazy Collection</em> untuk melakukan streaming file CSV,\nsehingga kita dapat melakukan export jutaan data tanpa harus menampung jutaan data tersebut ke dalam memori.</p>\n<h4 id=\"kenapa-csv\"><a href=\"#kenapa-csv\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Kenapa CSV?</h4>\n<p>Kenapa menggunakan CSV?, kenapa bukan file excel aja?</p>\n<p>Setahu saya, koreksi kalau salah loh ya. Saat ekspor data menjadi file excel, yang terjadi adalah\n(jutaan) data kamu akan dibuffer/ditampung kedalam konten file excel, setelah selesai,\nfile tersebut masih diolah lagi untuk dilakukan proses encoding,\nstyling (membuat border, warnai teks, merge-cells, dsb), sampai akhirnya <em>buntelan</em> file excel kamu siap,\nbarulah file excel kamu \"disajikan\" ke browser.</p>\n<p>Saat \"memasak\" (baca: mengolah) file excel tersebut, semakin banyak \"porsi\" (baca: baris) yang ingin dimasak, semakin besar pula \"wajan\" (baca: memori) yang harus digunakan untuk \"memasak\" file itu. Kalau \"wajan\"-nya tidak cukup besar, aplikasi kamu akan error, karena memorinya tidak mencukupi.</p>\n<p>Berbeda dengan CSV, file CSV hanya berisi teks biasa (<em>plain text</em>) yang setiap barisnya mewakili baris pada tabel, dimana pada setiap baris terdapat karakter \";\" atau \",\" sebagai pemisah dari masing-masing kolom. Kekurangannya, pada file CSV kita tidak bisa melakukan styling, formula, dsb seperti yang didukung oleh format excel. Tapi dengan kekurangan tersebut, kita dapat melakukan streaming konten CSV baris-per-baris, dari server dialirkan ke browser, dari browser dialirkan ke storage device user. Singkatnya: server kita tidak perlu menampung beban memori dari seluruh data di dalam file CSV yang hendak diekspor.</p>\n<h4 id=\"kenapa-lazy-collection\"><a href=\"#kenapa-lazy-collection\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Kenapa Lazy Collection?</h4>\n<p>Kalau kamu pernah menonton video yang saya sebutkan di awal, kamu akan mengerti peran Lazy Collection disini.\nSingkatnya, dengan Lazy Collection kita tidak perlu menampung data yang ingin kita ekspor,\nsehingga yang terjadi adalah data dari hasil query akan difetch satu-per-satu dari DBMS, untuk kemudian data tersebut\nditulis kedalam stream file CSV yang akan diterima dan diproses langsung oleh web browser.</p>\n<p>Secara keseluruhan, gambaran prosesnya nanti akan jadi (kurang-lebih) seperti ini:</p>\n<p><img src=\"/images/posts/export-jutaan-data-ke-csv-dengan-aman-di-laravel__1.png\" alt=\"Alur download stream csv\"></p>\n<h2 id=\"bagaimana-caranya\"><a href=\"#bagaimana-caranya\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Bagaimana Caranya?</h2>\n<p>Caranya sebetulnya sederhana.\nMisalkan disini kita memiliki model <code>App\\Models\\LogActivity.php</code> yang mewakili table <code>log_activities</code> yang berisi 10 juta data.\nDi dalam table tersebut, kita ingin export data <code>time</code>, <code>user_id</code>, <code>message</code>, <code>ip_address</code>, dan <code>user_agent</code>.</p>\n<p>Supaya agak panjang artikelnya, misalnya isi file modelnya kayak gini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #FF0078\">namespace</span><span style=\"color: #FFFFFF\"> Illuminate</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Database</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Eloquent</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Model</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #2BA8FF\">class</span><span style=\"color: #FFFFFF\"> LogActivity </span><span style=\"color: #2BA8FF\">extends</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">Model</span>\n<span style=\"color: #EFEFEF\">{</span>\n\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">protected</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">table </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">\"log_activities\"</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Dah, gitulah ya.</p>\n<p>Kemudian, kita menambahkan route seperti ini di <code>routes/web.php</code>:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">Route::get('log-activities/export', 'LogActivityController@export');</span></code></pre>\n<p>Setelah itu, pada controllernya kamu dapat menuliskan seperti ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #FF0078\">namespace</span><span style=\"color: #FFFFFF\"> App</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Http</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Controllers</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> App</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Models</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">LogActivity</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> Illuminate</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Http</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Request</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #2BA8FF\">class</span><span style=\"color: #FFFFFF\"> LogActivityController </span><span style=\"color: #2BA8FF\">extends</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">Controller</span>\n<span style=\"color: #EFEFEF\">{</span>\n\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">public</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">function</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">export</span><span style=\"color: #EFEFEF\">()</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 1. Ambil seluruh data log_activities kedalam LazyCollection (Generator)</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">logs </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">LogActivity</span><span style=\"color: #EFEFEF\">::</span><span style=\"color: #FFFFFF\">orderBy(</span><span style=\"color: #50E3C2\">'time'</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">cursor()</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// FYI: dibawah ini contoh kalau kamu mau gunakan condition dengan cursor</span>\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// $logs = LogActivity::whereRaw(\"DATE(time) = '2019-11-08'\")-&gt;where('user_id', 1)-&gt;cursor()</span>\n\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 2. Set header untuk streaming file CSV</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">\"log-activities.csv\"</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FAC863\">header</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Content-type: text/csv\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FAC863\">header</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"Content-Disposition: attachment; filename=</span><span style=\"color: #EFEFEF\">{$</span><span style=\"color: #FFFFFF\">filename</span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #50E3C2\">\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 3. Stream file CSV</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">fopen</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"php://output\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"w+\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 3.a. Tulis table header</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FAC863\">fputcsv</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv, </span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">\"Time\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"User ID\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"Message\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"IP Address\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"User Agent\"</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 3.b. Tulis baris setiap log</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FF0078\">foreach</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">logs </span><span style=\"color: #EFEFEF\">as</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #FAC863\">fputcsv</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv, </span><span style=\"color: #EFEFEF\">[</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">time,</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">user_id,</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">message,</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">ip_address,</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">user_agent</span>\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">}</span>\n<span style=\"color: #EFEFEF\">        </span><span style=\"color: #888\">// 3.c. Tutup file</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FAC863\">fclose</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<p>Selesai. Dengan begitu, ketika kamu mengakses <code>https://appkamu.com/log-activities/export</code>,\naplikasi kamu akan mengirimkan response berupa streaming file CSV yang berisi semua data didalam <code>log_activities</code>\ntanpa harus mengalami beban memori yang tinggi.</p>\n<hr>\n<p>Ngomong-ngomong, cara diatas adalah cara yang agak native karena kita langsung menggunakan fungsi <code>header</code> bawaan PHP.\nSaya tulis seperti itu supaya kamu tahu cara di native atau di framework lain seperti apa.\nKalau kamu penasaran cara yang \"lebih\" ke-Laravel-an, kamu dapat menggunakan fungsi <code>streamDownload</code> seperti dibawah ini:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #EFEFEF\">&lt;?php</span>\n\n<span style=\"color: #FF0078\">namespace</span><span style=\"color: #FFFFFF\"> App</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Http</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Controllers</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> App</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Models</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">LogActivity</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> Illuminate</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Http</span><span style=\"color: #EFEFEF\">\\</span><span style=\"color: #FFFFFF\">Request</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #2BA8FF\">class</span><span style=\"color: #FFFFFF\"> LogActivityController </span><span style=\"color: #2BA8FF\">extends</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">Controller</span>\n<span style=\"color: #EFEFEF\">{</span>\n\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #2BA8FF\">public</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">function</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">export</span><span style=\"color: #EFEFEF\">()</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">logs </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #2BA8FF\">LogActivity</span><span style=\"color: #EFEFEF\">::</span><span style=\"color: #FFFFFF\">orderBy(</span><span style=\"color: #50E3C2\">'time'</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">cursor()</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">\"log-activities.csv\"</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #FF0078\">return</span><span style=\"color: #FFFFFF\"> response()</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">streamDownload(</span><span style=\"color: #2BA8FF\">function</span><span style=\"color: #EFEFEF\">()</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FF0078\">use</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">($</span><span style=\"color: #FFFFFF\">logs</span><span style=\"color: #EFEFEF\">)</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv </span><span style=\"color: #EFEFEF\">=</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #FAC863\">fopen</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #50E3C2\">\"php://output\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"w+\"</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #FAC863\">fputcsv</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv, </span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">\"Time\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"User ID\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"Message\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"IP Address\"</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #50E3C2\">\"User Agent\"</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #FF0078\">foreach</span><span style=\"color: #FFFFFF\"> (</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">logs </span><span style=\"color: #EFEFEF\">as</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log) </span><span style=\"color: #EFEFEF\">{</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #FAC863\">fputcsv</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv, </span><span style=\"color: #EFEFEF\">[</span>\n<span style=\"color: #FFFFFF\">                    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">time,</span>\n<span style=\"color: #FFFFFF\">                    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">user_id,</span>\n<span style=\"color: #FFFFFF\">                    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">message,</span>\n<span style=\"color: #FFFFFF\">                    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">ip_address,</span>\n<span style=\"color: #FFFFFF\">                    </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">log</span><span style=\"color: #EFEFEF\">-&gt;</span><span style=\"color: #FFFFFF\">user_agent</span>\n<span style=\"color: #FFFFFF\">                </span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #FFFFFF\">            </span><span style=\"color: #FAC863\">fclose</span><span style=\"color: #FFFFFF\">(</span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">csv)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">        </span><span style=\"color: #EFEFEF\">}</span><span style=\"color: #FFFFFF\">, </span><span style=\"color: #EFEFEF\">$</span><span style=\"color: #FFFFFF\">filename, </span><span style=\"color: #EFEFEF\">[</span><span style=\"color: #50E3C2\">\"Content-type\"</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #EFEFEF\">=&gt;</span><span style=\"color: #FFFFFF\"> </span><span style=\"color: #50E3C2\">\"text/csv\"</span><span style=\"color: #EFEFEF\">]</span><span style=\"color: #FFFFFF\">)</span><span style=\"color: #EFEFEF\">;</span>\n<span style=\"color: #FFFFFF\">    </span><span style=\"color: #EFEFEF\">}</span>\n\n<span style=\"color: #EFEFEF\">}</span></code></pre>\n<hr>\n<p>Seperti itulah cara melakukan export CSV secara aman di Laravel. Kalau ada saran, masukan, atau pertanyaan, silahkan kontak facebook saya.\nAkhir kata, semoga bermanfaat.</p>\n","excerpt":"","description":"Bagaimana memanfaatkan generator dan streaming CSV untuk export jutaan data secara aman.","path":"/artikel/export-jutaan-data-ke-csv-dengan-aman-di-laravel/","cover":"/images/posts/export-jutaan-data-ke-csv-dengan-aman-di-laravel.png","icon":"/images/icons/laravel.png","tags":[{"id":"Laravel","title":"Laravel","path":"/tag/Laravel/"},{"id":"PHP","title":"PHP","path":"/tag/PHP/"}],"author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}},{"node":{"id":"be8e7a02e0533f43d78409c7df8d067e","title":"Redis University RU202 - Minggu Ke-2","datetime":"2019-08-23 11:00:00","content":"<p>Ini adalah catatan minggu ke-2 dari apa yang saya pelajari di kelas RU202-nya <a href=\"https://university.redislabs.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redis University</a> yang berjudul <strong>\"Redis Streams\"</strong>.</p>\n<p>Pada minggu ke-2 ini topik pembahasannya adalah:</p>\n<ol>\n<li>Producer</li>\n<li>Range Queries</li>\n<li>The Consumer</li>\n</ol>\n<h2 id=\"1-producer\"><a href=\"#1-producer\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>1. Producer</h2>\n<p>Pada bagian ini dijelaskan panjang lebar mengenai <em>stream producer</em>, disini saya rangkum saja kedalam beberapa poin dibawah ini: </p>\n<ul>\n<li><em>Stream Producer</em> adalah software/aplikasi yang berperan sebagai pengirim data kedalam stream.</li>\n<li>Data di dalam stream disebut sebagai 'message'.</li>\n<li><em>Stream Producer</em> menggunakan Redis Client API untuk memasukkan message kedalam stream.</li>\n<li>Pada Redis CLI, kita bisa menggunakan perintah <code>XADD stream_name message_id field value [field_2 value_2 ... field_n value_n]</code> untuk menambahkan message kedalam stream. Contoh untuk mengirim data temperatur kedalam stream: <code>XADD temperature * celcius 39</code>.</li>\n</ul>\n<h4 id=\"message-id\"><a href=\"#message-id\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Message ID</h4>\n<ul>\n<li>Untuk generate message ID secara otomatis, gunakan <code>*</code> (seperti contoh diatas). </li>\n<li>Message ID tidak dapat diubah.</li>\n<li>\n<p>Contoh message ID hasil generate: <code>1566533258158-0</code></p>\n<ul>\n<li><code>1566533258158</code>: <em>millisecond-timestamp</em>.</li>\n<li><code>0</code>: <em>sub-millisecond-sequence</em>, jika terdapat pesan dalam <em>millisecond-timestamp</em> yang sama, maka angka ini bertambah. Dan angka ini akan 0 kembali pada <em>millisecond-timestamp</em> yang berbeda.</li>\n</ul>\n</li>\n<li>\n<p>Contoh membuat message ID secara manual: <code>XADD mystream 100 x 1</code>.</p>\n<ul>\n<li>Message ID harus berupa unsigned integer (paling kecil 0).</li>\n<li>Hasil ID digenerate: <code>100-0</code> dimana <code>0</code> adalah urutan dari id <code>100</code>.</li>\n<li>Catatan: setelah menambahkan message dengan ID 100 kedalam stream mystream, maka kita tidak dapat menambahkan message dengan ID dibawah 100 kedalam stream mystream tersebut.</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"message-payload\"><a href=\"#message-payload\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Message Payload</h4>\n<ul>\n<li>Message payload pada Redis Stream memiliki struktur data seperti hash (<code>Map&#x3C;String, String></code>).</li>\n<li>Tidak ada batasan berapa field yang dapat disimpan didalam setiap message.</li>\n<li>\n<p>Redis akan secara otomatis melakukan kompresi pada nama field di stream yang sama, contoh:</p>\n<ul>\n<li><code>XADD coordinates * latitude 0.1 longitude 1.0</code></li>\n<li><code>XADD coordinates * latitude 0.2 longitude 1.0</code></li>\n<li><code>XADD coordinates * latitude 0.3 longitude 1.1</code></li>\n<li>Pada 3 perintah <code>XADD</code> diatas, maka redis tidak akan menyimpan nama field <code>latitude</code> dan <code>longitude</code> pada 2 perintah <code>XADD</code> bawahnya.</li>\n<li>Tapi, jika perintah <code>XADD</code> selanjutnya memiliki field yang berbeda, entah ditambah field baru, atau ada field yang berubah, maka redis akan menyimpan nama field message tersebut secara utuh.</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"managing-the-length-of-a-stream\"><a href=\"#managing-the-length-of-a-stream\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Managing the Length of a Stream</h4>\n<p>Untuk membatasi banyaknya message pada stream supaya tidak terlalu bengkak, dapat gunakan beberapa cara berikut:</p>\n<ol>\n<li>Gunakan <code>XADD</code> dengan <code>MAXLEN</code>. Contoh <code>XADD mystream * foo bar MAXLEN 1000</code>, maka jika ini adalah message yang ke-1001, message paling lama akan dihapus sehingga jumlah messagenya menjadi 1000.</li>\n<li>Gunakan perintah <code>XDEL</code>. Cara ini tidak dianjurkan karena tidak efektif.</li>\n<li>Gunakan perintah <code>XTRIM</code>. Contoh <code>XTRIM mystream MAXLEN 1000</code>, maka message ke 1001 sampai dengan yang paling lama akan dihapus.</li>\n</ol>\n<p>Yang saya masih bingung setelah melakukan proses diatas, message pada stream memang betul akan hilang,\ndalam artian ketika kita gunakan <code>XRANGE mystream - +</code> message yang terhapus tidak lagi muncul. Tetapi saat digunakan <code>MEMORY USAGE mystream</code>, memori yang terpakai masih sama. Dia ngasih tau sih memang saat menghapus message pada stream, message tidak secara langsung hilang, melainkan hanya diberi flag \"deleted\". Cuma yang masih belum saya tau, kapan memori tersebut benar-benar dihapus?</p>\n<p>Selain cara diatas, sebetulnya ada cara lain yang disarankan, yaitu menggunakan <code>XTRIM mystream MAXLEN ~ 1000</code>, atau <code>XADD mystream * foo bar MAXLEN ~ 1000</code>, ini penjelasan mereka tentang tanga <code>~</code>:</p>\n<blockquote>\n<p>The ~ argument between the MAXLEN option and the actual count means that the user is not really requesting that the stream length is exactly 1000 items, but instead it could be a few tens of entries more, but never less than 1000 items. When this option modifier is used, the trimming is performed only when Redis is able to remove a whole macro node. This makes it much more efficient, and it is usually what you want.</p>\n</blockquote>\n<p>Kenapa saya tidak masukkan cara ini di list, karena saya belum mengerti betul cara kerja si <code>~</code> itu.\nDisitu tertulis \"could be a few tens of entries more\", jadi saya coba buat stream dengan 100 message, dengan harapan setelah saya coba <code>XTRIM mystream MAXLEN ~ 10</code> maka akan menghapus <code>mystream</code> menjadi 10-50 message (few tens more). Tapi ternyata tidak terjadi apa-apa, <code>XLEN mystream</code> masih tetap 100.</p>\n<p>Entahlah, mungkin kalau messagenya ribuan bakal dihapus. Mungkin.</p>\n<h2 id=\"2-range-queries\"><a href=\"#2-range-queries\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>2. Range Queries</h2>\n<p>Untuk mengambil  message dalam range ID tertentu, dapat menggunakan perintah <code>XRANGE</code> dan <code>XREVRANGE</code>. Perbedaannya adalah <code>XRANGE</code> akan mengambil message dan mengurutkannya secara <em>ascending</em> (dari paling awal), <code>XREVRANGE</code> akan mengambil message dan mengurutkannya secara <em>descending</em> (dari paling akhir).</p>\n<p>Berikut contoh-contoh penggunaan <code>XRANGE</code> dan <code>XREVRANGE</code>:</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #888\"># Beberapa cara mengambil semua message di dalam mystream</span>\n<span style=\"color: #FFFFFF\">XRANGE mystream - +</span>\n<span style=\"color: #FFFFFF\">XRANGE mystream 0-0 +</span>\n\n<span style=\"color: #888\"># Mengambil semua message dari 1526985054069-0 s/d data terakhir di dalam mystream</span>\n<span style=\"color: #FFFFFF\">XRANGE mystream 1526985054069-0 +</span>\n\n<span style=\"color: #888\"># Mengambil semua message diantara 1526985054069-0 s/d 1531243452312-0 terakhir di dalam mystream</span>\n<span style=\"color: #FFFFFF\">XRANGE mystream 1526985054069-0 1531243452312-0</span>\n\n<span style=\"color: #888\"># Mengambil 10 message PERTAMA dari mystream</span>\n<span style=\"color: #FFFFFF\">XRANGE mystream - + COUNT 10</span>\n\n<span style=\"color: #888\"># Mengambil 10 message TERAKHIR dari mystream</span>\n<span style=\"color: #FFFFFF\">XREVRANGE mystream + - COUNT 10</span></code></pre>\n<p>Tanda <code>-</code> dan <code>+</code> adalah special ID, <code>-</code> adalah alias untuk ID awal (0-0), sedangkan <code>+</code> adalah alias untuk ID terakhir (18446744073709551615-18446744073709551615).</p>\n<h2 id=\"3-the-consumer\"><a href=\"#3-the-consumer\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>3. The Consumer</h2>\n<p>Untuk men-<em>consume</em> data pada stream, dapat menggunakan perintah <code>XREAD</code>. Berikut adalah beberapa contoh penggunaan <code>XREAD</code>.</p>\n<pre class=\"shiki\" style=\"background-color: #191d21\"><code><span style=\"color: #FFFFFF\">XREAD COUNT 1 STREAMS mystream</span></code></pre>\n","excerpt":"","description":"Catatan kelas Redis University RU102 minggu ke-2","path":"/artikel/redis-university-ru202-minggu-ke-2/","cover":"/images/posts/ru202-w2-cover.png","icon":"/images/icons/redis.png","tags":[{"id":"Redis University","title":"Redis University","path":"/tag/Redis%20University/"},{"id":"Course","title":"Course","path":"/tag/Course/"},{"id":"RU202","title":"RU202","path":"/tag/RU202/"}],"author":{"id":"Muhammad Syifa","title":"Muhammad Syifa","path":"/author/Muhammad%20Syifa/"}}}]},"featuredOpenSources":{"edges":[{"node":{"slug":"rakit-validation","title":"Rakit Validation","description":"PHP Validation Library","thumbnail":"/images/open-sources/api-wilayah.png","demoUrl":"https://packagist.org/packages/rakit/validation","repoUrl":"https://www.github.com/rakit/validation/","techStack":["PHP","Composer"]}},{"node":{"slug":"api-wilayah-indonesia","title":"API Statis Wilayah Indonesia","description":"API statis data wilayah Indonesia","thumbnail":"/images/open-sources/api-wilayah.png","demoUrl":"https://emsifa.github.io/api-wilayah-indonesia/","repoUrl":"https://www.github.com/emsifa/api-wilayah-indonesia/","techStack":["PHP","Vue","Bootstrap 4"]}},{"node":{"slug":"cronmu","title":"CRONmu","description":"Aplikasi pemandu cron kamu","thumbnail":"/images/open-sources/cronmu.png","demoUrl":"https://emsifa.github.io/cronmu/","repoUrl":"https://www.github.com/emsifa/cronmu/","techStack":["Svelte","Tailwindcss","PEGjs","GitHub Page"]}}]},"openSources":{"count":13}},"context":{}}