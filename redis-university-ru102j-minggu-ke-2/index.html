<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" class="h-full" data-vue-tag="lang,class">
  <head>
    <title data-vue-tag="true">Redis University RU102J - Minggu Ke-2 </title><meta data-vue-tag="true" charset="utf-8"><meta data-vue-tag="true" name="generator" content="Gridsome v0.6.7"><meta data-vue-tag="true" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="true" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="true" data-key="description" name="description" content="Catatan kelas Redis University RU102 minggu ke-2"><meta data-vue-tag="true" property="og:type" content="article"><meta data-vue-tag="true" property="og:title" content="Redis University RU102J - Minggu Ke-2"><meta data-vue-tag="true" property="og:description" content="Catatan kelas Redis University RU102 minggu ke-2"><meta data-vue-tag="true" property="og:url" content="https://blog.emsifa.com/redis-university-ru102j-minggu-ke-2/"><meta data-vue-tag="true" property="article:published_time" content="2019-08-22"><meta data-vue-tag="true" property="og:image" content="https://blog.emsifa.com/images/posts/ru102j-w2-cover.png"><meta data-vue-tag="true" name="twitter:card" content="summary_large_image"><meta data-vue-tag="true" name="twitter:title" content="Redis University RU102J - Minggu Ke-2"><meta data-vue-tag="true" name="twitter:description" content="Catatan kelas Redis University RU102 minggu ke-2"><meta data-vue-tag="true" name="twitter:site" content="@cossssmin"><meta data-vue-tag="true" name="twitter:creator" content="@cossssmin"><meta data-vue-tag="true" name="twitter:image" content="/images/posts/ru102j-w2-cover.png"><link data-vue-tag="true" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.74da076.png"><link data-vue-tag="true" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.74da076.png"><link data-vue-tag="true" rel="apple-touch-icon" type="image/png" sizes="48x48" href="/assets/static/favicon.f8b3168.74da076.png"><noscript data-vue-tag="true" ><style>.g-image--loading{display:none;}</style></noscript><link rel="preload" href="/assets/css/7.styles.3c5e2248.css" as="style"><link rel="preload" href="/assets/js/app.b7ff0605.js" as="script"><link rel="preload" href="/assets/js/page--src-templates-post-vue.f3023cf4.js" as="script"><link rel="prefetch" href="/assets/js/9.be2a7d10.js"><link rel="prefetch" href="/assets/js/page--src-pages-404-vue.9956444d.js"><link rel="prefetch" href="/assets/js/page--src-pages-index-vue.5d498baa.js"><link rel="prefetch" href="/assets/js/page--src-templates-author-vue.df5b087f.js"><link rel="prefetch" href="/assets/js/page--src-templates-tag-vue.d231eeda.js"><link rel="prefetch" href="/assets/js/vendors~page--src-pages-index-vue~page--src-templates-author-vue~page--src-templates-post-vue~page--~ed3ac5eb.0bdbde02.js"><link rel="prefetch" href="/assets/js/vendors~page--src-templates-post-vue.0f12d6b5.js"><link rel="stylesheet" href="/assets/css/7.styles.3c5e2248.css">
  </head>
  <body class="antialiased" data-vue-tag="class">
    <div data-server-rendered="true" id="app"><main><header><div class="pt-24"><h1 class="text-4xl sm:text-5xl md:text-6xl font-sans font-bold mb-1"><a href="/" class="text-black w-full inline-block text-center active"><img src="/images/logo.png" alt="Logo" class="inline" style="height:100px;"></a></h1><div class="max-w-xl md:max-w-3xl xl:max-w-4xl mx-auto text-center px-6"><h1 class="text-3xl sm:text-5xl leading-tight font-sans font-bold mb-4 text-gray-700">Redis University RU102J - Minggu Ke-2</h1><p class="text-gray-700"><time datetime="2019-08-18 09:00:00" class="capitalize">18 August 2019</time>
        •
        <span>5 min read</span></p><p class="text-gray-700 text-xs mt-2 uppercase"></p><img src="/images/posts/ru102j-w2-cover.png" alt="Redis University RU102J - Minggu Ke-2" class="mt-12"></div></div></header><article class="max-w-xl md:max-w-2xl xl:max-w-3xl mx-auto px-6 sm:px-12 pt-16 pb-16"><!----><div class="markdown text-lg leading-normal text-gray-700 pb-10"><p>Ini adalah catatan minggu ke-2 saya di kelas RU102J-nya Redis University.
Jika pada minggu pertama hanya sebatas setup java environment, java redis client dan perkenalan DAO pattern,
pada minggu ini kita mulai membuat aplikasi RediSolar.</p>
<p>Spesifiknya, minggu ini topik pembahasannya adalah:</p>
<ol>
<li>Pengenalan Data Model</li>
<li>Metrics with Sorted Sets</li>
<li>Making Lua Script</li>
<li>Pipelining with Jedis</li>
<li>Transactions with Jedis</li>
</ol>
<h2 id="1-pengenalan-data-model"><a href="#1-pengenalan-data-model" aria-hidden="true"><span class="icon icon-link"></span></a>1. Pengenalan Data Model</h2>
<p>Data model ini sebetulnya sudah sedikit disinggung pada minggu pertama pada diagram DAO.
Cuma disini dicontohkan membuat data model untuk MeterReading (meteran).</p>
<p>Jadi untuk membuat aplikasi RediSolar ini, kita membutuhkan data model class MeterReading dengan
properti seperti dibawah ini:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #81A1C1">public</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">class</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">MeterReading</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> siteId</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">            </span><span style="color: #4C566A">// ID lokasi (rumah)</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">ZonedDateTime</span><span style="color: #D8DEE9FF"> dateTime</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// waktu</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Double</span><span style="color: #D8DEE9FF"> whUsed</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">          </span><span style="color: #4C566A">// daya digunakan</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Double</span><span style="color: #D8DEE9FF"> whGenerated</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">     </span><span style="color: #4C566A">// daya digenerate</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Double</span><span style="color: #D8DEE9FF"> tempC</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">           </span><span style="color: #4C566A">// suhu dalam celcius</span>
<span style="color: #ECEFF4">}</span></code></pre>
<h2 id="2-metrics-with-sorted-sets"><a href="#2-metrics-with-sorted-sets" aria-hidden="true"><span class="icon icon-link"></span></a>2. Metrics with Sorted Sets</h2>
<p>Kemudian untuk menyimpan metric, struktur data yang digunakan adalah sorted sets dengan
format key dan value seperti dibawah ini:</p>
<p>Format key:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #D8DEE9FF">metrics:wHg:2020-01-01:1</span></code></pre>
<p>Dimana:</p>
<ul>
<li><code class="shiki-inline" style="background: #2e3440; color: #d8dee9">metrics</code>: prefix</li>
<li><code class="shiki-inline" style="background: #2e3440; color: #d8dee9">wHg</code>: unit (satuan)</li>
<li><code class="shiki-inline" style="background: #2e3440; color: #d8dee9">2020-01-01</code>: tanggal</li>
<li><code class="shiki-inline" style="background: #2e3440; color: #d8dee9">1</code>: site ID</li>
</ul>
<p>Sedangkan untuk struktur sorted setnya adalah sebagai berikut:</p>
<ul>
<li>score: menit</li>
<li>value: nilai:menit</li>
</ul>
<p>Contoh, perintah <code class="shiki-inline" style="background: #2e3440; color: #d8dee9">ZADD</code> dibawah ini maksudnya adalah:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #D8DEE9FF">ZADD metrics:wHg:2020-01-01:1 30 18.5:30</span></code></pre>
<ul>
<li>Unit: wHg (watt hours generated)</li>
<li>Tanggal: 2020-01-01</li>
<li>Site ID: 1</li>
<li>Menit: 30</li>
<li>Nilai: 18.5</li>
</ul>
<p>Struktur seperti diatas digunakan karena:</p>
<ol>
<li>Pengukuran (metrics) akan secara otomatis disortir.</li>
<li>Efisien untuk di fetch: O((log n) + m).</li>
<li>Efisien untuk insert: O(log n).</li>
<li>Hemat memori.</li>
</ol>
<h2 id="3-making-lua-script"><a href="#3-making-lua-script" aria-hidden="true"><span class="icon icon-link"></span></a>3. Making Lua Script</h2>
<p>Topik pembahasan selanjutnya adalah tentang tata cara menjalankan script Lua pada Java untuk melakukan atomic transaction di Redis. Kalau di MySQL atau RDBMS lain mungkin kalian familiar dengan istilah stored procedure, nah si Lua disini perannya seperti itu.</p>
<p>Sebagai contoh, kita ingin membuat script untuk mengupdate sebuah key, hanya jika key belum ada, atau nilai yang baru lebih rendah dari nilainya saat ini.</p>
<p>Pertama kita harus persiapkan class <code class="shiki-inline" style="background: #2e3440; color: #d8dee9">UpdateIfLowerScript</code> sebagai berikut (pahami sendiri):</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #81A1C1">public</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">class</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">UpdateIfLowerScript</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span>

<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">final</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Jedis</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">final</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">String</span><span style="color: #D8DEE9FF"> sha</span><span style="color: #81A1C1">;</span>

<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">private</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">final</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">static</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">String</span><span style="color: #D8DEE9FF"> script </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">local key = KEYS[1]</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF">  </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">local new = ARGS[1]</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF">  </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">local current = redis.call('GET', key)</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF">  </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">if (current == false or (tonumber(new) &lt; tonumber(current))) then</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">    redis.call('SET', key, new)</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF"> </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">    return 1</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF">  </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">else</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF"> </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">    return 0</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span><span style="color: #D8DEE9FF"> </span>
<span style="color: #D8DEE9FF">        </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">end</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">+</span>

<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">public</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">UpdateIfLowerScript</span><span style="color: #ECEFF4">(</span><span style="color: #8FBCBB">Jedis</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">this.</span><span style="color: #D8DEE9FF">jedis </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">this.</span><span style="color: #D8DEE9FF">sha </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">scriptLoad</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">script</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span>

<span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">public</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">boolean</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">updateIfLower</span><span style="color: #ECEFF4">(</span><span style="color: #8FBCBB">String</span><span style="color: #D8DEE9FF"> key</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Integer</span><span style="color: #D8DEE9FF"> newValue</span><span style="color: #ECEFF4">)</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #8FBCBB">List&lt;String&gt;</span><span style="color: #D8DEE9FF"> keys </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Collections</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">singletonList</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">key</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #8FBCBB">List&lt;String&gt;</span><span style="color: #D8DEE9FF"> args </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">Collections</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">singletonList</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">newValue</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">        </span><span style="color: #8FBCBB">Object</span><span style="color: #D8DEE9FF"> response </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">evalsha</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">sha</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> keys</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> args</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span>

<span style="color: #D8DEE9FF">        </span><span style="color: #81A1C1">return</span><span style="color: #D8DEE9FF"> (</span><span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF">) response </span><span style="color: #81A1C1">==</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1</span><span style="color: #81A1C1">;</span>
<span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">}</span>
<span style="color: #D8DEE9FF">}</span></code></pre>
<p>Selanjutnya, cara panggilnya ya tinggal buat aja instancenya, lalu panggil methodnya seperti dibawah ini:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #8FBCBB">UpdateIfLowerScript</span><span style="color: #D8DEE9FF"> script </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">new</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">UpdateIfLowerScript</span><span style="color: #D8DEE9FF">(jedis)</span><span style="color: #81A1C1">;</span>
<span style="color: #81A1C1">boolean</span><span style="color: #D8DEE9FF"> result </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> script</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">updateIfLower</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">'</span><span style="color: #A3BE8C">keynya</span><span style="color: #ECEFF4">'</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">100</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span></code></pre>
<p>Oia katanya biasanya bakal banyak script Lua di project Java kita, jadi supaya rapih sebisa mungkin dibuat 1 script 1 class, dan disimpan dalam 1 folder yang sama.</p>
<p>Dan kenapa nggak pakai script Java aja langsung? seperti yang disinggung diatas, script Lua ini bersifat atomic.
Yang artinya script akan membloking eksekusi dari Redis Client lain sampai script Lua ini selesai dijalankan.
Jadi tidak ada transaksi dari Redis Client lain yang terselip ditengah-tengah Lua script ini.</p>
<h2 id="4-pipelining-with-jedis"><a href="#4-pipelining-with-jedis" aria-hidden="true"><span class="icon icon-link"></span></a>4. Pipelining with Jedis</h2>
<p>Pembahasan selanjutnya adalah tentang penggunaan pipeline. Pada DBMS lain, istilah yang mirip-mirip dengan pipeline adalah transaction. Dengan pipeline kita bisa mengirim banyak perintah sekaligus sehingga Redis Client nggak perlu bolak-balik request-response ke Redis Server.</p>
<p>Bayangin kamu ke warung mau beli mie instan dan saos. Jika kamu adalah Redis Client, secara default kamu akan bolak-balik, beli mie instan dulu, sampai rumah, kemudian balik lagi untuk beli saos, terus balik lagi ke rumah. Dengan pipeline, kamu (si Redis Client) akan membeli mie instan dan saos secara bersamaan. Efeknya? tentu saja mempercepat waktu eksekusi dan latency.</p>
<p>Di Jedis sendiri, cara menggunakan pipeline adalah sebagai berikut:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> siteId </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1L</span><span style="color: #81A1C1">;</span>
<span style="color: #8FBCBB">Pipeline</span><span style="color: #D8DEE9FF"> p </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">pipelined</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">  </span><span style="color: #4C566A">// inisiasi pipeline</span>

<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> hsetResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> p</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">hset</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">statusKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">available</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">true</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push hset command to pipeline</span>
<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> expireResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> p</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">expire</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">statusKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1000</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push expire command to pipeline</span>
<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> saddResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> p</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">sadd</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">availableKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">String</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">valueOf</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">siteId</span><span style="color: #ECEFF4">))</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push sadd command to pipeline</span>

<span style="color: #D8DEE9FF">p</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">sync</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// run pipeline to execute all commands</span>

<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> hsetResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> hsetResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from p.hset</span>
<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> expireResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> expireResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from p.expire</span>
<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> saddResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> saddResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from p.sadd</span></code></pre>
<p>Dengan pipeine seperti diatas, 3 perintah akan dikirim ke Redis Server secara bersamaan.
Hanya saja, sifat pipeline tidak seperti transaksi, dimana jika salah satunya gagal, Redis tidak akan merollback command sebelumnya. Dan juga saat pipeline berjalan, katakanlah kita mengirim 100 perintah, kemudian pada perintah ke 70 ada Redis Client mengirim perintah juga, maka perintah dari Redis Client lain akan berjalan ditengah-tengah pipeline.</p>
<h2 id="5-transactions-with-jedis"><a href="#5-transactions-with-jedis" aria-hidden="true"><span class="icon icon-link"></span></a>5. Transactions with Jedis</h2>
<p>Pembahasan selanjutnya adalah tentang transaction. Transaction di Redis ini mirip-mirip dengan pipeline,
hanya saja transaction mendukung atomic transaction. Jika kita menjalankan 5 perintah menggunakan transaction,
maka jika ada Redis Client lain mengirim perintah ke Redis Server yang sama, maka Redis Client lain tersebut harus menunggu sampai 5 perintah kita selesai dijalankan.</p>
<p>Contoh menerapkan transaction menggunakan Jedis:</p>
<pre class="shiki" style="background-color: #2e3440"><code><span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> siteId </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1L</span><span style="color: #81A1C1">;</span>
<span style="color: #8FBCBB">Transaction</span><span style="color: #D8DEE9FF"> t </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> jedis</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">multi</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF">  </span><span style="color: #4C566A">// inisiasi transaction</span>

<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> hsetResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> t</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">hset</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">statusKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">available</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">true</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push hset command to transaction</span>
<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> expireResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> t</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">expire</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">statusKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">1000</span><span style="color: #ECEFF4">)</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push expire command to transaction</span>
<span style="color: #8FBCBB">Response&lt;Long&gt;</span><span style="color: #D8DEE9FF"> saddResponse </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> t</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">sadd</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">availableKey</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">String</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">valueOf</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">siteId</span><span style="color: #ECEFF4">))</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// push sadd command to transaction</span>

<span style="color: #D8DEE9FF">t</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">exec</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// run transaction to execute all commands</span>

<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> hsetResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> hsetResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from t.hset</span>
<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> expireResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> expireResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from t.expire</span>
<span style="color: #8FBCBB">Long</span><span style="color: #D8DEE9FF"> saddResult </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> saddResponse</span><span style="color: #81A1C1">.</span><span style="color: #88C0D0">get</span><span style="color: #ECEFF4">()</span><span style="color: #81A1C1">;</span><span style="color: #D8DEE9FF"> </span><span style="color: #4C566A">// get result from t.sadd</span></code></pre>
<h2 id="kapan-harus-menggunakan-lua-script-pipeline-dan-transaction"><a href="#kapan-harus-menggunakan-lua-script-pipeline-dan-transaction" aria-hidden="true"><span class="icon icon-link"></span></a>Kapan Harus Menggunakan Lua Script, Pipeline, dan Transaction?</h2>
<ol>
<li>Jika kamu membolehkan ada query dari client lain berjalan di tengah-tengah multiple query, gunakan Pipeline.</li>
<li>Jika kamu tidak ingin ada query dari client lain berjalan di tengah-tengah multiple query, gunakan Transaction.</li>
<li>Jika kamu ingin menggunakan conditional statement di tengah-tengah eksekusi multiple query, gunakan Lua Script.</li>
</ol>
<hr>
<p>Begitulah topik pembahasan di kelas RU102J di minggu ke-2. Yaudah, sampai jumpa lagi di minggu selanjutnya.</p>
</div><footer class="flex flex-wrap pb-10 sm:pb-16"><div><a href="/tag/Redis%20University/" class="inline-block text-gray-600 hover:text-white hover:bg-gray-600 border border-gray-600 font-sans font-semibold text-xs sm:text-sm px-4 py-2 mr-4 mb-2 rounded-full transition-color transition-bg">
          Redis University
          </a><a href="/tag/Course/" class="inline-block text-gray-600 hover:text-white hover:bg-gray-600 border border-gray-600 font-sans font-semibold text-xs sm:text-sm px-4 py-2 mr-4 mb-2 rounded-full transition-color transition-bg">
          Course
          </a><a href="/tag/RU102J/" class="inline-block text-gray-600 hover:text-white hover:bg-gray-600 border border-gray-600 font-sans font-semibold text-xs sm:text-sm px-4 py-2 mr-4 mb-2 rounded-full transition-color transition-bg">
          RU102J
          </a></div></footer></article><footer class="text-gray-700 text-sm leading-normal flex flex-wrap justify-between mx-auto max-w-3xl px-6 sm:px-12 pb-8 sm:pb-10"><div class="w-full sm:w-1/2 mb-4 sm:mb-0 text-gray-600"><p>© 2019</p></div><div class="w-full sm:w-1/2"><nav><ul class="flex sm:justify-end -mx-2"><li class="px-2"><a href="/" class="text-gray-600 border-b border-transparent hover:border-gray-400 transition-border-color active">Home</a></li><li class="px-2"><a href="/sitemap.xml" class="text-gray-600 border-b border-transparent hover:border-gray-400 transition-border-color">Sitemap</a></li><li class="px-2"><a href="/feed.xml" class="text-gray-600 border-b border-transparent hover:border-gray-400 transition-border-color">RSS Feed</a></li></ul></nav></div></footer></main></div>
    <script src="/assets/js/app.b7ff0605.js" defer></script><script src="/assets/js/page--src-templates-post-vue.f3023cf4.js" defer></script>
  </body>
</html>
